# Logging & EventID's

# Windows Eventlogs


POWERSHELL (SCRIPT BLOCK LOGGING)

EventID 	: 4104
LogSource	: Microsoft-Windows-Powershell/Operational

Enabled by default on WIN10/11, validate if you find these logs in eventviewer, can be enforced by GPO. Using GPO's has some advantages

- Comprehensive Logging: Unlike default logging (limited to engine/provider and suspicious blocks), GPO-enabled Script Block Logging captures all script activity, including non-suspicious and obfuscated code. 
- Centralized Management: GPO ensures consistent logging across enterprise systems, unlike manual registry changes. 
- Granular Insights: Logs full script content, execution context (user, process ID), and deobfuscated code, critical for detecting fileless attacks. 

> Deobfuscation: Script Block Logging, when enabled (GPO or manual), always deobfuscates Base64-encoded scripts, logging the decoded content in Event ID 4104. Default logging (`AMSI only`) deobfuscates suspicious Base64 scripts but misses others.

> PowerShell Script Block Logging: AMSI logs suspicious scripts as Event ID 4104 (warning level) in Microsoft-Windows-PowerShell/Operational by default, with Base64 deobfuscation for detected threats. If Script Block Logging is enabled (GPO or registry), AMSI events are included in verbose 4104 logs, capturing all scripts (malicious or not). Deobfuscation: AMSI deobfuscates Base64-encoded scripts in both logs for detected threats. Enabled Script Block Logging deobfuscates all scripts, increasing exposure.

WINDOWS DEFENDER

EventID 	: 1116 (detection)
EventID     : 1117 (action taken)
LogSource   : Microsoft-Windows-Windows Defender/Operational

AMSI Event Logging:

AMSI also logs to Microsoft-Windows-Windows Defender/Operational as Event ID 1116 (detection) and 1117 (action taken), providing AV-specific details (e.g., threat name, process).



RDP CONNECTION Logs

EventID 	: 1149
LogSource	: Microsoft-Windows-Terminal-Services-RemoteConnectionManager

Enabled by default – no GPO configuration required – validate if you find these logs in eventviewer.


SERVICE CREATION Logs

EventID 	: 7045
LogSource	: SYSTEM

Enabled by default – no GPO configuration required – validate if you find these logs in eventviewer.


WMI Activity Logs

EventID 	: 5861
LogSource	: Microsoft-Windows-WMI-Activity/Operational

Enabled by default – no GPO configuration required – validate if you find these logs in eventviewer. Not always present, depends on WMI activity.


Event Log Clearing Logs

EventID 	: 1102
LogSource	: Security

Enabled by default – no GPO configuration required – validate if you find these logs in eventviewer. Not always present, only when event logs have been cleared.


PROCESS EXECUTION AND COMMAND LINE Logs

EventID 	: 4688
LogSource	: Security

To enable process creation logging, go to Computer Configuration\Windows Settings\Security Settings\Advanced Audit Policy Configuration\Audit Policies\Detailed Tracking
•	Double-click "Audit Process Creation"
•	Check the box "Configure the following audit events"
•	Check the box "Success" and "Failure

Then enable the command line arguments logging by going to Computer Configuration\Administrative Templates\System\Audit Process Creation 
•	Double-click "Include command line in process creation events" and set to Enabled

# Sysmon Event IDs for Red Team Analysis

This table summarizes the Sysmon Event IDs from the Microsoft Sysinternals documentation (v15.15, July 23, 2024) at [https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon). It includes implications for red team operations, focusing on detection/forensics and capabilities, particularly for fileless/memory-based attacks and C# tools.

| **Event ID** | **Event Type**              | **Description**                                                                                                                                                                         | **Red Team Implications (Detection/Forensics)**                                                                                                                                                                                                                                                                                                                                      | **Red Team Implications (Capabilities)**                                                                                                                                                        |
| ------------ | --------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1            | Process Creation            | Logs process creation with full command line for current and parent processes. Includes process GUID for correlation, hashes (SHA1 default, MD5, SHA256, or IMPHASH), and session GUID. | **Detection Risk**: High. Captures command-line arguments and hashes, exposing C# tools using PowerShell or .NET (e.g., `powershell.exe` spawning processes). EDRs correlate these events to detect malicious activity. **Forensic Impact**: Detailed logs (e.g., process lineage, hashes) aid in reconstructing C# attack chains, especially if using `System.Diagnostics.Process`. | **Impact on C#**: Limits stealth of C# payloads relying on process spawning (e.g., via `Process.Start`). Red teams must obfuscate command lines or use in-memory execution to minimize logging. |
| 2            | File Creation Time Change   | Logs changes to file creation times, useful for detecting timestomping (altering file metadata to evade detection).                                                                     | **Detection Risk**: Moderate. Fileless C# attacks (e.g., in-memory PowerShell) don’t typically modify file times, but disk-based persistence (e.g., registry writes) may trigger this. **Forensic Impact**: Helps defenders detect timestomping attempts, though less relevant for purely memory-based C# attacks.                                                                   | **Impact on C#**: Minimal for fileless attacks, but C# tools writing to disk (e.g., for persistence) must avoid metadata changes or use anti-forensic techniques to evade.                      |
| 3            | Network Connection          | Logs network connections, including source/destination IP, port, and protocol.                                                                                                          | **Detection Risk**: High. C# tools using `System.Net` (e.g., for C2 communication) trigger this event, exposing network activity to EDRs. **Forensic Impact**: Detailed connection logs help trace C2 servers, impacting Havoc or C# C2 operations.                                                                                                                                  | **Impact on C#**: Red teams must use encrypted channels (e.g., HTTPS) or proxies to mask C2 traffic. Havoc’s `TrustXForwardedFor` setting may mitigate but requires careful configuration.      |
| 5            | Process Terminated          | Logs when a process ends, including process ID and GUID.                                                                                                                                | **Detection Risk**: Low. Termination of C# processes (e.g., `powershell.exe`) may be logged but is less suspicious unless correlated with other events. **Forensic Impact**: Aids in reconstructing process lifecycle but less critical for fileless attacks.                                                                                                                        | **Impact on C#**: Minimal impact, as process termination is normal. Red teams should ensure C# payloads persist in memory to avoid repeated process creation.                                   |
| 6            | Driver Loaded               | Logs loading of drivers or DLLs, including signatures and hashes.                                                                                                                       | **Detection Risk**: Moderate. C# tools using P/Invoke to load unsigned DLLs (e.g., for injection) may trigger this. **Forensic Impact**: Hashes and signatures expose unsigned or malicious DLLs used in C# attacks.                                                                                                                                                                 | **Impact on C#**: Avoids direct driver loading but P/Invoke calls (e.g., `LoadLibrary`) may still trigger. Use signed DLLs or in-memory loading to evade.                                       |
| 7            | Image Loaded                | Logs loading of DLLs or modules into processes, including hashes and signatures.                                                                                                        | **Detection Risk**: High. C# tools using `System.Reflection` or P/Invoke for in-memory DLL loading (e.g., reflective injection) trigger this event. **Forensic Impact**: Exposes loaded modules, aiding memory forensics (e.g., Volatility analyzing .NET assemblies).                                                                                                               | **Impact on C#**: Reflective DLL injection in C# (e.g., via `Assembly.Load`) is less stealthy due to this event. Red teams should minimize module loading or use obfuscation.                   |
| 8            | CreateRemoteThread          | Logs creation of threads in another process, often used for process injection.                                                                                                          | **Detection Risk**: Critical. C# tools performing process injection (e.g., via `CreateRemoteThread` in P/Invoke) are highly likely to be flagged by EDRs. **Forensic Impact**: Directly links to injection techniques, exposing Havoc or C# payloads.                                                                                                                                | **Impact on C#**: Injection-based C# attacks (e.g., Havoc’s `notepad.exe` injection) are at high risk. Use stealthier processes (e.g., `svchost.exe`) or avoid injection.                       |
| 9            | Raw Disk Access             | Logs raw read access to disks or volumes.                                                                                                                                               | **Detection Risk**: Low. Fileless C# attacks rarely involve raw disk access. **Forensic Impact**: Minimal unless C# tools manipulate disk structures directly.                                                                                                                                                                                                                       | **Impact on C#**: Negligible for memory-based attacks, as C# typically operates at a higher level.                                                                                              |
| 10           | Process Access              | Logs when a process opens another process, often for injection or memory manipulation.                                                                                                  | **Detection Risk**: High. C# tools using `OpenProcess` (e.g., for injection) trigger this, alerting EDRs. **Forensic Impact**: Reveals process tampering, critical for tracing C# injection attacks.                                                                                                                                                                                 | **Impact on C#**: Increases risk for C# injection tools (e.g., Havoc’s injection settings). Use stealthier processes or avoid direct process access.                                            |
| 11           | File Create                 | Logs file creation or overwrite, useful for monitoring autostart or malware drop locations.                                                                                             | **Detection Risk**: Moderate. Fileless C# attacks avoid this, but persistence mechanisms (e.g., dropping files via `System.IO`) trigger it. **Forensic Impact**: Exposes disk-based artifacts, less relevant for memory-based C# attacks.                                                                                                                                            | **Impact on C#**: Encourages fully fileless C# payloads (e.g., PowerShell, .NET reflection) to avoid disk writes.                                                                               |
| 12           | Registry Create/Delete      | Logs creation or deletion of registry keys/values, useful for autostart or malware persistence monitoring.                                                                              | **Detection Risk**: Moderate. C# tools modifying registry (e.g., for persistence via `Microsoft.Win32`) trigger this. **Forensic Impact**: Exposes persistence mechanisms, aiding forensic analysis.                                                                                                                                                                                 | **Impact on C#**: Red teams must minimize registry writes or use in-memory persistence to evade detection.                                                                                      |
| 13           | Registry Value Set          | Logs modifications to registry values (DWORD/QWORD types).                                                                                                                              | **Detection Risk**: Moderate. Similar to Event 12, C# tools setting registry values (e.g., via `Registry.SetValue`) are logged. **Forensic Impact**: Reveals configuration changes, critical for tracing C# persistence.                                                                                                                                                             | **Impact on C#**: Avoid registry modifications in C# tools to maintain stealth, favoring memory-based techniques.                                                                               |
| 14           | Registry Rename             | Logs renaming of registry keys or values.                                                                                                                                               | **Detection Risk**: Low. Rare in C# attacks unless manipulating registry for persistence. **Forensic Impact**: Limited unless C# tools rename keys (e.g., to hide persistence).                                                                                                                                                                                                      | **Impact on C#**: Minimal impact, as registry renaming is uncommon in fileless attacks.                                                                                                         |
| 15           | File Create Stream          | Logs creation of named file streams, including hashes of the file and stream contents.                                                                                                  | **Detection Risk**: Moderate. C# tools downloading files (e.g., via `System.Net.WebClient`) may trigger this if streams include Zone.Identifier metadata. **Forensic Impact**: Exposes browser-based drops, less relevant for pure memory attacks.                                                                                                                                   | **Impact on C#**: Avoid browser-based downloads in C#; use in-memory payloads to bypass stream logging.                                                                                         |
| 16           | Sysmon Configuration Change | Logs changes to Sysmon’s configuration (e.g., updated filtering rules).                                                                                                                 | **Detection Risk**: Low. Not directly tied to red team actions unless tampering with Sysmon. **Forensic Impact**: Indicates potential attacker interference with Sysmon.                                                                                                                                                                                                             | **Impact on C#**: Negligible unless C# tools attempt to disable Sysmon (e.g., via `sc stop Sysmon`).                                                                                            |
| 17           | Named Pipe Creation         | Logs creation of named pipes, often used for interprocess communication by malware.                                                                                                     | **Detection Risk**: Moderate. C# tools using named pipes (e.g., via `System.IO.Pipes`) trigger this. **Forensic Impact**: Exposes IPC mechanisms, aiding attribution of C# payloads.                                                                                                                                                                                                 | **Impact on C#**: Avoid named pipes in C# tools; use alternative C2 channels (e.g., TCP/HTTP).                                                                                                  |
| 18           | Named Pipe Connection       | Logs connections between named pipe clients and servers.                                                                                                                                | **Detection Risk**: Moderate. Similar to Event 17, C# tools using pipes for C2 or data exfiltration are logged. **Forensic Impact**: Links pipe-based communication, aiding forensic tracing.                                                                                                                                                                                        | **Impact on C#**: Prefer network-based C2 in C# to avoid pipe-related logging.                                                                                                                  |
| 22           | DNSCache                    | Logs DNS queries made by processes.                                                                                                                                                     | **Detection Risk**: High. C# tools resolving C2 domains (e.g., via `System.Net.Dns`) trigger this, exposing C2 infrastructure. **Forensic Impact**: Reveals domain resolutions, critical for tracing C2 servers.                                                                                                                                                                     | **Impact on C#**: Use hard-coded IPs or DNS over HTTPS in C# to minimize DNS logging.                                                                                                           |
| 23           | File Delete                 | Logs file deletion events, including hashes of deleted files.                                                                                                                           | **Detection Risk**: Moderate. C# tools deleting files (e.g., via `System.IO.File.Delete`) trigger this, exposing cleanup attempts. **Forensic Impact**: Aids in tracking anti-forensic actions.                                                                                                                                                                                      | **Impact on C#**: Minimize file operations in C# to avoid deletion logs; focus on memory-based attacks.                                                                                         |
| 24           | Clipboard Change            | Logs changes to the clipboard, often used by malware for data theft.                                                                                                                    | **Detection Risk**: Low. Rare in C# attacks unless stealing clipboard data (e.g., via `System.Windows.Forms.Clipboard`). **Forensic Impact**: Exposes data exfiltration attempts.                                                                                                                                                                                                    | **Impact on C#**: Avoid clipboard access in C# unless critical, as it’s a low-priority attack vector.                                                                                           |
| 25           | Process Tampering           | Logs attempts to tamper with process memory (e.g., hollowing, injection).                                                                                                               | **Detection Risk**: Critical. C# injection tools (e.g., using `VirtualAllocEx`, `WriteProcessMemory`) are highly likely to be flagged. **Forensic Impact**: Directly links to advanced injection techniques, critical for Havoc or C# attacks.                                                                                                                                       | **Impact on C#**: Injection-based C# payloads (e.g., Havoc’s `notepad.exe` injection) are at high risk. Use stealthier processes or avoid injection.                                            |
| 26           | File Delete Detected        | Logs when Sysmon detects a file being deleted by another process.                                                                                                                       | **Detection Risk**: Moderate. Similar to Event 23, C# cleanup scripts trigger this. **Forensic Impact**: Exposes anti-forensic actions, aiding attribution.                                                                                                                                                                                                                          | **Impact on C#**: Minimize file operations in C# to avoid deletion logs; focus on memory-based attacks.                                                                                         |
| 27           | File Block Executable       | Logs when Sysmon blocks an executable file from running.                                                                                                                                | **Detection Risk**: High for disk-based payloads. Fileless C# attacks (e.g., PowerShell) avoid this. **Forensic Impact**: Limited to disk-based artifacts, less relevant for memory attacks.                                                                                                                                                                                         | **Impact on C#**: Fileless C# payloads bypass this event, reinforcing their utility for stealth.                                                                                                |
| 28           | File Block Shredding        | Logs when Sysmon prevents secure file deletion (shredding).                                                                                                                             | **Detection Risk**: Low. Rare in C# unless using secure delete libraries. **Forensic Impact**: Exposes anti-forensic attempts.                                                                                                                                                                                                                                                       | **Impact on C#**: Negligible, as secure deletion is uncommon in fileless C# attacks.                                                                                                            |
| 29           | File Executable Detected    | Logs detection of executable files, including hashes and signatures.                                                                                                                    | **Detection Risk**: High for disk-based C# payloads. Fileless attacks (e.g., .NET reflection) avoid this. **Forensic Impact**: Exposes dropped executables, less relevant for memory-based C# attacks.                                                                                                                                                                               | **Impact on C#**: Reinforces use of fileless C# techniques (e.g., PowerShell, `Assembly.Load`) to evade detection.                                                                              |
| 255          | Error                       | Generated when a Sysmon error occurs (e.g., heavy system load, bugs, or security violations).                                                                                           | **Detection Risk**: Low. Not directly tied to red team actions. **Forensic Impact**: May indicate system stress or tampering attempts, but not specific to C# attacks.                                                                                                                                                                                                               | **Impact on C#**: Negligible unless C# tools cause Sysmon errors (e.g., via resource exhaustion).                                                                                               |

## Notes
- **Source**: Derived from [https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon).
- **Havoc Profile Context**: Injection into `notepad.exe` (from your `havoc.yaotl`) triggers Event IDs 8 and 10, increasing detection risk. Switching to `svchost.exe` enhances stealth for fileless attacks.
- **C# Context**: Sysmon’s logging (e.g., Event IDs 1, 3, 7, 8, 10) challenges C# tools due to .NET telemetry and behavioral detection. Use obfuscation, encrypted C2, and in-memory execution to mitigate.
- **Mitigation**: Avoid logged APIs (e.g., `Process.Start`, `Registry.SetValue`), use AMSI bypasses for PowerShell-based C# payloads, and prefer memory-based techniques to evade Sysmon.
